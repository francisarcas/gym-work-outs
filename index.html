<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Tracker Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ==================== CSS VARIABLES ==================== */
        :root {
            /* Colors */
            --primary: #0A84FF;
            --primary-dark: #0066CC;
            --success: #32D74B;
            --warning: #FFD60A;
            --danger: #FF453A;
            --purple: #BF5AF2;
            --orange: #FF9500;
            
            /* Backgrounds */
            --bg-primary: #000000;
            --bg-secondary: #1C1C1E;
            --bg-tertiary: #2C2C2E;
            --bg-elevated: rgba(28, 28, 30, 0.95);
            
            /* Text */
            --text-primary: #FFFFFF;
            --text-secondary: rgba(235, 235, 245, 0.6);
            --text-tertiary: rgba(235, 235, 245, 0.3);
            
            /* Borders & Dividers */
            --border: rgba(84, 84, 88, 0.6);
            --divider: rgba(84, 84, 88, 0.3);
            
            /* Effects */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
            --blur: blur(20px) saturate(180%);
            
            /* Spacing */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            
            /* Transitions */
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ==================== RESET & BASE ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        /* ==================== LAYOUT ==================== */
        .app {
            min-height: 100vh;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* ==================== HEADER ==================== */
        .header {
            margin-bottom: 32px;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--purple));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .logo-text h1 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-text p {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        /* ==================== NAVIGATION ==================== */
        .nav {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 4px;
            display: inline-flex;
            gap: 4px;
        }

        .nav-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            text-align: center;
        }

        .nav-btn:hover {
            color: var(--text-primary);
        }

        .nav-btn.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        /* ==================== BUTTONS ==================== */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
            text-align: center;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: rgba(10, 132, 255, 0.15);
            color: var(--primary);
            border: 1px solid rgba(10, 132, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(10, 132, 255, 0.25);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: rgba(255, 69, 58, 0.15);
            color: var(--danger);
            border: 1px solid rgba(255, 69, 58, 0.3);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ==================== CARDS ==================== */
        .card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            padding: 24px;
            margin-bottom: 24px;
            backdrop-filter: var(--blur);
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
        }

        /* ==================== FORMS ==================== */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 15px;
            transition: var(--transition);
            height: 45px;
        }

        .form-textarea {
            height: auto;
            min-height: 80px;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.2);
        }

        .form-input::placeholder {
            color: var(--text-tertiary);
        }

        .form-textarea {
            resize: vertical;
            font-family: inherit;
        }

        /* Increase gap before submit button */
        #workout-form > button[type="submit"] {
            margin-top: 24px;
        }

        /* ==================== STATS GRID ==================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--color-start), var(--color-end));
            border-radius: var(--radius-lg);
            padding: 20px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(30%, -30%);
        }

        .stat-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            line-height: 1;
        }

        .stat-unit {
            font-size: 14px;
            font-weight: 500;
            opacity: 0.9;
            margin-left: 4px;
        }

        /* ==================== TABLE ==================== */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--bg-secondary);
            padding: 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 16px;
            border-bottom: 1px solid var(--divider);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* ==================== BADGES ==================== */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .badge-running { background: rgba(255, 149, 0, 0.2); color: var(--orange); }
        .badge-cycling { background: rgba(255, 214, 10, 0.2); color: var(--warning); }
        .badge-swimming { background: rgba(10, 132, 255, 0.2); color: var(--primary); }
        .badge-weights { background: rgba(191, 90, 242, 0.2); color: var(--purple); }
        .badge-strength { background: rgba(191, 90, 242, 0.2); color: var(--purple); }
        .badge-core { background: rgba(191, 90, 242, 0.2); color: var(--purple); }
        .badge-yoga { background: rgba(50, 215, 75, 0.2); color: var(--success); }
        .badge-pilates { background: rgba(50, 215, 75, 0.2); color: var(--success); }
        .badge-hiit { background: rgba(255, 69, 58, 0.2); color: var(--danger); }
        .badge-rowing { background: rgba(10, 132, 255, 0.2); color: var(--primary); }
        .badge-other { background: rgba(142, 142, 147, 0.2); color: #8e8e93; }

        /* ==================== WORKOUT LIST ==================== */
        .workout-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .workout-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 16px;
            transition: var(--transition);
            cursor: pointer;
        }

        .workout-item:hover {
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .workout-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .workout-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .workout-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--divider);
        }

        .workout-detail {
            font-size: 13px;
        }

        .workout-detail-label {
            color: var(--text-secondary);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .workout-detail-value {
            font-weight: 600;
            margin-top: 4px;
        }

        /* ==================== CHART ==================== */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        canvas {
            max-width: 100%;
            display: block;
        }

        /* ==================== PREP BUILDER ==================== */
        .prep-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 24px;
        }

        .step-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .step-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }

        .step-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
        }

        .step-item.warmup::before { background: var(--success); }
        .step-item.work::before { background: var(--warning); }
        .step-item.rest::before { background: var(--primary); }
        .step-item.cooldown::before { background: var(--purple); }

        .step-item.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(10, 132, 255, 0.2);
            background: rgba(10, 132, 255, 0.05);
        }

        .step-info {
            flex: 1;
            padding-left: 12px;
        }

        .step-phase {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .step-title {
            font-size: 16px;
            font-weight: 700;
            margin: 4px 0;
        }

        .step-detail {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .summary-card {
            background: linear-gradient(135deg, var(--primary), var(--purple));
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .summary-value {
            font-size: 48px;
            font-weight: 800;
            line-height: 1;
        }

        .summary-label {
            font-size: 14px;
            font-weight: 600;
            opacity: 0.9;
            margin-top: 8px;
        }

        /* ==================== PLAYER CONTROLS ==================== */
        .player-status {
            text-align: center;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 16px;
            font-size: 14px;
            font-weight: 600;
        }

        .player-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .btn-play {
            grid-column: 1 / -1;
            position: relative;
            overflow: hidden;
            width: 100%;
        }

        .btn-play::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: var(--progress, 0%);
            background: rgba(255, 255, 255, 0.1);
            transition: width 1s linear;
        }

        /* ==================== EMPTY STATE ==================== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 16px;
        }

        /* ==================== VIEWS ==================== */
        .view {
            display: none;
        }

        .view.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .app {
                padding: 16px;
            }

            .header-top {
                flex-direction: column;
                align-items: flex-start;
            }

            .nav {
                width: 100%;
            }

            .nav-btn {
                flex: 1;
                text-align: center;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .prep-grid {
                grid-template-columns: 1fr;
            }

            .player-controls {
                grid-template-columns: 1fr;
            }

            .btn-play {
                grid-column: 1;
            }

            .workout-meta {
                flex-wrap: wrap;
            }

            .workout-details {
                grid-template-columns: 1fr;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .form-select {
                width: 100% !important;
            }
        }

        /* ==================== UTILITIES ==================== */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 16px; }
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-top">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-dumbbell"></i>
                    </div>
                    <div class="logo-text">
                        <h1>Workout Tracker Pro</h1>
                        <p>Track. Analyze. Improve.</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="app.importData()">
                        <i class="fas fa-file-import"></i>
                        Import
                    </button>
                    <button class="btn btn-secondary" onclick="app.exportData()">
                        <i class="fas fa-file-export"></i>
                        Export
                    </button>
                </div>
            </div>
            <nav class="nav">
                <button class="nav-btn active" onclick="app.switchView('tracker')">
                    <i class="fas fa-list"></i> Tracker
                </button>
                <button class="nav-btn" onclick="app.switchView('analytics')">
                    <i class="fas fa-chart-line"></i> Analytics
                </button>
                <button class="nav-btn" onclick="app.switchView('prep')">
                    <i class="fas fa-clipboard-list"></i> Workout Prep
                </button>
            </nav>
        </header>

        <!-- Tracker View -->
        <div id="view-tracker" class="view active">
            <!-- Log Workout Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Log Workout</h2>
                </div>
                <form id="workout-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-input" id="workout-date" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Activity Type</label>
                            <select class="form-select" id="workout-type" required>
                                <option>Running</option>
                                <option>Swimming</option>
                                <option>Weights</option>
                                <option>Strength</option>
                                <option>Core</option>
                                <option>Cycling</option>
                                <option>Rowing</option>
                                <option>Yoga</option>
                                <option>Pilates</option>
                                <option>HIIT</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Duration (minutes)</label>
                            <input type="number" class="form-input" id="workout-duration" min="1" required>
                        </div>
                    </div>

                    <!-- Dynamic Fields -->
                    <div id="dynamic-fields"></div>

                    <div class="form-group">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea class="form-textarea" id="workout-notes" placeholder="How did it feel?"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-plus"></i>
                        Log Workout
                    </button>
                </form>
            </div>

            <!-- Recent Workouts -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Recent Workouts</h2>
                    <span class="text-secondary" id="workout-count">0 workouts</span>
                </div>
                <div id="workout-list" class="workout-list"></div>
            </div>
        </div>

        <!-- Analytics View -->
        <div id="view-analytics" class="view">
            <!-- Stats Overview -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Overview</h2>
                    <select class="form-select" id="stats-period" style="width: auto;">
                        <option value="7">Last 7 Days</option>
                        <option value="30" selected>Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                        <option value="365">Last Year</option>
                    </select>
                </div>
                <div class="stats-grid" id="stats-grid"></div>
            </div>

            <!-- Activity Chart -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Activity Trend</h2>
                    <select class="form-select" id="chart-type" style="width: auto;">
                        <option value="all">All Activities</option>
                        <option value="Running">Running</option>
                        <option value="Cycling">Cycling</option>
                        <option value="Swimming">Swimming</option>
                        <option value="Weights">Weights</option>
                        <option value="Strength">Strength</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="activity-chart"></canvas>
                </div>
            </div>

            <!-- Breakdown Table -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Activity Breakdown</h2>
                </div>
                <div class="table-container">
                    <table id="breakdown-table">
                        <thead>
                            <tr>
                                <th>Activity</th>
                                <th>Count</th>
                                <th>Total Time</th>
                                <th>Avg Duration</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Workout Prep View -->
        <div id="view-prep" class="view">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Workout Builder</h2>
                    <select class="form-select" id="prep-sport" style="width: auto;">
                        <option value="Running">Running</option>
                        <option value="Cycling">Cycling</option>
                        <option value="Rowing">Rowing</option>
                    </select>
                </div>

                <div class="prep-grid">
                    <!-- Workout Plan -->
                    <div>
                        <div class="summary-card">
                            <div class="summary-value" id="prep-total-time">0</div>
                            <div class="summary-label">Total Minutes</div>
                            <div class="mt-1" id="prep-total-distance">0 km estimated</div>
                        </div>

                        <div id="prep-step-list" class="step-list">
                            <div class="empty-state">
                                <i class="fas fa-clipboard-list"></i>
                                <p>Add steps to build your workout</p>
                            </div>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div>
                        <!-- Add Step Panel -->
                        <div class="card" style="margin-bottom: 16px;">
                            <h3 style="margin-bottom: 16px;">Add Step</h3>
                            
                            <div class="form-group mb-2">
                                <label class="form-label">Phase</label>
                                <select class="form-select" id="step-phase">
                                    <option value="warmup">Warm Up</option>
                                    <option value="work" selected>Work</option>
                                    <option value="rest">Rest</option>
                                    <option value="cooldown">Cool Down</option>
                                </select>
                            </div>

                            <div class="form-group mb-2">
                                <label class="form-label">Target</label>
                                <select class="form-select" id="step-target">
                                    <option value="time">Duration (Time)</option>
                                    <option value="distance">Distance</option>
                                </select>
                            </div>

                            <div class="form-group mb-2">
                                <label class="form-label" id="step-value-label">Duration (minutes)</label>
                                <input type="number" class="form-input" id="step-value" step="0.1" placeholder="30">
                            </div>

                            <div id="step-intensity-fields"></div>

                            <div class="form-group mb-2">
                                <label class="form-label">Preview</label>
                                <div style="padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md); color: var(--primary); font-weight: 600;" id="step-preview">
                                    Enter values to see preview
                                </div>
                            </div>

                            <button class="btn btn-success" style="width: 100%;" onclick="app.addPrepStep()">
                                <i class="fas fa-plus"></i>
                                Add Step
                            </button>
                        </div>

                        <!-- Player Panel -->
                        <div class="card">
                            <h3 style="margin-bottom: 16px;">Workout Player</h3>
                            
                            <div class="player-status" id="player-status">
                                Ready to start
                            </div>

                            <button class="btn btn-primary btn-play" id="play-btn" onclick="app.togglePlay()">
                                <i class="fas fa-play" id="play-icon"></i>
                                <span id="play-text">Start Workout</span>
                            </button>

                            <div class="player-controls hidden" id="player-controls">
                                <button class="btn btn-secondary" onclick="app.skipStep(-1)">
                                    <i class="fas fa-step-backward"></i>
                                </button>
                                <button class="btn btn-danger" onclick="app.stopWorkout()">
                                    <i class="fas fa-stop"></i>
                                </button>
                                <button class="btn btn-secondary" onclick="app.skipStep(1)">
                                    <i class="fas fa-step-forward"></i>
                                </button>
                            </div>

                            <button class="btn btn-danger mt-2" style="width: 100%;" onclick="app.clearPlan()">
                                <i class="fas fa-trash"></i>
                                Clear Plan
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="import-file" accept=".json" style="display: none;">

    <script>
        // ==================== APPLICATION STATE ====================
        const app = {
            workouts: [],
            prepSteps: [],
            player: {
                isPlaying: false,
                currentStep: 0,
                timeRemaining: 0,
                totalTime: 0,
                interval: null
            },

            // ==================== INITIALIZATION ====================
            init() {
                this.loadData();
                this.setupEventListeners();
                this.setDefaultDate();
                this.renderWorkoutList();
                this.updateDynamicFields(); // Initialize dynamic fields
                // Don't call updateAnalytics on init since we're not on that view
            },

            loadData() {
                try {
                    const data = localStorage.getItem('workoutTrackerPro');
                    if (data) {
                        this.workouts = JSON.parse(data);
                    }
                } catch (e) {
                    console.error('Error loading data:', e);
                    this.workouts = [];
                }
            },

            saveData() {
                try {
                    localStorage.setItem('workoutTrackerPro', JSON.stringify(this.workouts));
                } catch (e) {
                    console.error('Error saving data:', e);
                }
            },

            setupEventListeners() {
                // Workout form
                document.getElementById('workout-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addWorkout();
                });

                // Dynamic field updates
                document.getElementById('workout-type').addEventListener('change', () => {
                    this.updateDynamicFields();
                });

                // Analytics updates
                document.getElementById('stats-period').addEventListener('change', () => {
                    this.updateAnalytics();
                });

                document.getElementById('chart-type').addEventListener('change', () => {
                    this.updateChart();
                });

                // Prep builder updates
                document.getElementById('prep-sport').addEventListener('change', () => {
                    this.updatePrepUI();
                });

                document.getElementById('step-target').addEventListener('change', () => {
                    this.updatePrepUI();
                });

                // Real-time preview
                ['step-value', 'step-intensity-pace', 'step-intensity-speed', 'step-intensity-split'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('input', () => this.updateStepPreview());
                    }
                });

                // Import file
                document.getElementById('import-file').addEventListener('change', (e) => {
                    this.handleImport(e);
                });
            },

            setDefaultDate() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('workout-date').value = today;
            },

            // ==================== VIEW SWITCHING ====================
            switchView(viewName) {
                // Update nav buttons
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.closest('.nav-btn').classList.add('active');

                // Update views
                document.querySelectorAll('.view').forEach(view => {
                    view.classList.remove('active');
                });
                document.getElementById(`view-${viewName}`).classList.add('active');

                // Update view-specific data
                if (viewName === 'analytics') {
                    // Small delay to ensure canvas is rendered
                    setTimeout(() => {
                        this.updateAnalytics();
                    }, 50);
                }
            },

            // ==================== WORKOUT MANAGEMENT ====================
            addWorkout() {
                const workout = {
                    id: Date.now(),
                    date: document.getElementById('workout-date').value,
                    type: document.getElementById('workout-type').value,
                    duration: parseFloat(document.getElementById('workout-duration').value),
                    notes: document.getElementById('workout-notes').value,
                    details: this.collectDynamicFields()
                };

                this.workouts.unshift(workout);
                this.workouts.sort((a, b) => new Date(b.date) - new Date(a.date));
                this.saveData();
                this.renderWorkoutList();
                
                // Update analytics if we're on that view
                if (document.getElementById('view-analytics').classList.contains('active')) {
                    this.updateAnalytics();
                }

                // Reset form
                document.getElementById('workout-form').reset();
                this.setDefaultDate();
                this.updateDynamicFields();
            },

            deleteWorkout(id) {
                if (!confirm('Delete this workout?')) return;
                
                this.workouts = this.workouts.filter(w => w.id !== id);
                this.saveData();
                this.renderWorkoutList();
                
                // Update analytics if we're on that view
                if (document.getElementById('view-analytics').classList.contains('active')) {
                    this.updateAnalytics();
                }
            },

            updateDynamicFields() {
                const type = document.getElementById('workout-type').value;
                const container = document.getElementById('dynamic-fields');
                
                const fields = {
                    'Running': `
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Distance (km)</label>
                                <input type="number" class="form-input dynamic-field" data-label="Distance" step="0.01" placeholder="5.0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Pace (min/km)</label>
                                <input type="number" class="form-input dynamic-field" data-label="Pace" step="0.01" placeholder="5.30">
                            </div>
                        </div>
                    `,
                    'Cycling': `
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Distance (km)</label>
                                <input type="number" class="form-input dynamic-field" data-label="Distance" step="0.1" placeholder="20.0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Avg Speed (km/h)</label>
                                <input type="number" class="form-input dynamic-field" data-label="Speed" step="0.1" placeholder="25.0">
                            </div>
                        </div>
                    `,
                    'Swimming': `
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Distance (m)</label>
                                <input type="number" class="form-input dynamic-field" data-label="Distance" placeholder="1000">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Pool Size (m)</label>
                                <input type="number" class="form-input dynamic-field" data-label="Pool Size" value="25">
                            </div>
                        </div>
                    `,
                    'Rowing': `
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Distance (m)</label>
                                <input type="number" class="form-input dynamic-field" data-label="Distance" placeholder="5000">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Split (min/500m)</label>
                                <input type="number" class="form-input dynamic-field" data-label="Split" step="0.01" placeholder="2.00">
                            </div>
                        </div>
                    `,
                    'Weights': `
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Exercise</label>
                                <select class="form-select dynamic-field" data-label="Exercise">
                                    <option value="">Select Exercise...</option>
                                    <optgroup label="Lower Body – Squat Pattern (Quad Dominant)">
                                        <option>Low-Bar Back Squat</option>
                                        <option>High-Bar Back Squat</option>
                                        <option>Front Squat</option>
                                        <option>Paused Back Squat</option>
                                        <option>Box Squat</option>
                                        <option>Safety Bar Squat (SSB)</option>
                                        <option>Tempo Squat</option>
                                    </optgroup>
                                    <optgroup label="Upper Body – Horizontal Push (Bench Press Pattern)">
                                        <option>Competition Bench Press (Paused)</option>
                                        <option>Close-Grip Bench Press</option>
                                        <option>Paused Bench Press</option>
                                        <option>Board Press / Pin Press</option>
                                        <option>Floor Press</option>
                                        <option>Spoto Press</option>
                                    </optgroup>
                                    <optgroup label="Lower Body – Hinge Pattern (Deadlift)">
                                        <option>Conventional Deadlift</option>
                                        <option>Sumo Deadlift</option>
                                        <option>Deficit Deadlift</option>
                                        <option>Paused Deadlift</option>
                                        <option>Rack Pull</option>
                                        <option>Block Pull</option>
                                        <option>Trap Bar Deadlift</option>
                                    </optgroup>
                                    <optgroup label="Upper Body – Vertical Push (Overhead Press Pattern)">
                                        <option>Strict Standing Overhead Press / Military Press</option>
                                        <option>Push Press</option>
                                        <option>Seated Overhead Press</option>
                                    </optgroup>
                                    <optgroup label="Pulling / Back Strength (Assistance for Balance)">
                                        <option>Weighted Pull-ups / Chin-ups</option>
                                        <option>Barbell Bent-Over Row</option>
                                        <option>Pendlay Row</option>
                                        <option>Heavy Barbell Shrugs</option>
                                    </optgroup>
                                    <optgroup label="Core / Grip / Assistance for Strength">
                                        <option>Heavy Ab Wheel Rollouts</option>
                                        <option>Weighted Planks</option>
                                        <option>Farmer's Walks / Heavy Carries</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sets</label>
                                <input type="number" class="form-input dynamic-field" data-label="Sets" placeholder="3">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reps</label>
                                <input type="number" class="form-input dynamic-field" data-label="Reps" placeholder="10">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Weight (kg)</label>
                                <input type="number" class="form-input dynamic-field" data-label="Weight" step="0.5" placeholder="60">
                            </div>
                        </div>
                    `,
                    'Strength': `
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Exercise</label>
                                <select class="form-select dynamic-field" data-label="Exercise">
                                    <option value="">Select Strength Exercise...</option>
                                    <optgroup label="Lower Body – Squat Pattern (Quad Dominant)">
                                        <option>Low-Bar Back Squat</option>
                                        <option>High-Bar Back Squat</option>
                                        <option>Front Squat</option>
                                        <option>Paused Back Squat</option>
                                        <option>Box Squat</option>
                                        <option>Safety Bar Squat (SSB)</option>
                                        <option>Tempo Squat</option>
                                    </optgroup>
                                    <optgroup label="Upper Body – Horizontal Push (Bench Press Pattern)">
                                        <option>Competition Bench Press (Paused)</option>
                                        <option>Close-Grip Bench Press</option>
                                        <option>Paused Bench Press</option>
                                        <option>Board Press / Pin Press</option>
                                        <option>Floor Press</option>
                                        <option>Spoto Press</option>
                                    </optgroup>
                                    <optgroup label="Lower Body – Hinge Pattern (Deadlift)">
                                        <option>Conventional Deadlift</option>
                                        <option>Sumo Deadlift</option>
                                        <option>Deficit Deadlift</option>
                                        <option>Paused Deadlift</option>
                                        <option>Rack Pull</option>
                                        <option>Block Pull</option>
                                        <option>Trap Bar Deadlift</option>
                                    </optgroup>
                                    <optgroup label="Upper Body – Vertical Push (Overhead Press Pattern)">
                                        <option>Strict Standing Overhead Press / Military Press</option>
                                        <option>Push Press</option>
                                        <option>Seated Overhead Press</option>
                                    </optgroup>
                                    <optgroup label="Pulling / Back Strength (Assistance for Balance)">
                                        <option>Weighted Pull-ups / Chin-ups</option>
                                        <option>Barbell Bent-Over Row</option>
                                        <option>Pendlay Row</option>
                                        <option>Heavy Barbell Shrugs</option>
                                    </optgroup>
                                    <optgroup label="Core / Grip / Assistance for Strength">
                                        <option>Heavy Ab Wheel Rollouts</option>
                                        <option>Weighted Planks</option>
                                        <option>Farmer's Walks / Heavy Carries</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sets</label>
                                <input type="number" class="form-input dynamic-field" data-label="Sets" placeholder="3">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reps</label>
                                <input type="number" class="form-input dynamic-field" data-label="Reps" placeholder="5">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Weight (kg)</label>
                                <input type="number" class="form-input dynamic-field" data-label="Weight" step="0.5" placeholder="100">
                            </div>
                        </div>
                    `,
                    'Core': `
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Exercise</label>
                                <input type="text" class="form-input dynamic-field" data-label="Exercise" placeholder="e.g., Planks">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sets</label>
                                <input type="number" class="form-input dynamic-field" data-label="Sets" placeholder="3">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reps / Time</label>
                                <input type="text" class="form-input dynamic-field" data-label="Reps/Time" placeholder="60s">
                            </div>
                        </div>
                    `,
                    'Yoga': `
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Style</label>
                                <input type="text" class="form-input dynamic-field" data-label="Style" placeholder="e.g., Vinyasa">
                            </div>
                        </div>
                    `,
                    'Pilates': `
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Focus</label>
                                <input type="text" class="form-input dynamic-field" data-label="Focus" placeholder="e.g., Mat work">
                            </div>
                        </div>
                    `,
                    'HIIT': `
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Format</label>
                                <input type="text" class="form-input dynamic-field" data-label="Format" placeholder="e.g., Tabata">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Rounds</label>
                                <input type="number" class="form-input dynamic-field" data-label="Rounds" placeholder="8">
                            </div>
                        </div>
                    `,
                    'Other': `
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Details</label>
                                <input type="text" class="form-input dynamic-field" data-label="Details" placeholder="Activity details">
                            </div>
                        </div>
                    `
                };

                container.innerHTML = fields[type] || '';
            },

            collectDynamicFields() {
                const details = [];
                document.querySelectorAll('.dynamic-field').forEach(input => {
                    if (input.value) {
                        details.push({
                            label: input.dataset.label,
                            value: input.value
                        });
                    }
                });
                return details;
            },

            renderWorkoutList() {
                const container = document.getElementById('workout-list');
                const count = document.getElementById('workout-count');
                
                count.textContent = `${this.workouts.length} workout${this.workouts.length !== 1 ? 's' : ''}`;

                if (this.workouts.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-running"></i>
                            <p>No workouts logged yet. Start tracking!</p>
                        </div>
                    `;
                    return;
                }

                const recent = this.workouts.slice(0, 20);
                container.innerHTML = recent.map(workout => {
                    const date = new Date(workout.date + 'T00:00:00');
                    const dateStr = date.toLocaleDateString('en-US', { 
                        weekday: 'short', 
                        month: 'short', 
                        day: 'numeric' 
                    });

                    const badgeClass = `badge-${workout.type.toLowerCase()}`;
                    
                    return `
                        <div class="workout-item">
                            <div class="workout-header">
                                <div>
                                    <span class="badge ${badgeClass}">${workout.type}</span>
                                </div>
                                <button class="btn btn-icon btn-danger" onclick="app.deleteWorkout(${workout.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="workout-meta">
                                <span><i class="fas fa-calendar"></i> ${dateStr}</span>
                                <span><i class="fas fa-clock"></i> ${workout.duration} min</span>
                            </div>
                            ${workout.details.length > 0 ? `
                                <div class="workout-details">
                                    ${workout.details.map(d => `
                                        <div class="workout-detail">
                                            <div class="workout-detail-label">${d.label}</div>
                                            <div class="workout-detail-value">${d.value}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            ${workout.notes ? `
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--divider); font-style: italic; color: var(--text-secondary);">
                                    "${workout.notes}"
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            },

            // ==================== ANALYTICS ====================
            updateAnalytics() {
                this.updateStats();
                this.updateChart();
                this.updateBreakdown();
            },

            updateStats() {
                const period = parseInt(document.getElementById('stats-period').value);
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - period);

                const filtered = this.workouts.filter(w => new Date(w.date) >= cutoff);

                const stats = {
                    total: filtered.length,
                    totalTime: filtered.reduce((sum, w) => sum + w.duration, 0),
                    totalDistance: 0,
                    avgDuration: 0
                };

                // Calculate distance for cardio activities
                filtered.forEach(w => {
                    const dist = w.details.find(d => d.label === 'Distance');
                    if (dist) {
                        stats.totalDistance += parseFloat(dist.value) || 0;
                    }
                });

                stats.avgDuration = filtered.length > 0 ? Math.round(stats.totalTime / filtered.length) : 0;

                const container = document.getElementById('stats-grid');
                container.innerHTML = `
                    <div class="stat-card" style="--color-start: var(--primary); --color-end: #0066CC;">
                        <div class="stat-label">Total Workouts</div>
                        <div class="stat-value">${stats.total}</div>
                    </div>
                    <div class="stat-card" style="--color-start: var(--success); --color-end: #28a745;">
                        <div class="stat-label">Total Time</div>
                        <div class="stat-value">${Math.round(stats.totalTime / 60)}<span class="stat-unit">hrs</span></div>
                    </div>
                    <div class="stat-card" style="--color-start: var(--warning); --color-end: #ff9500;">
                        <div class="stat-label">Total Distance</div>
                        <div class="stat-value">${stats.totalDistance.toFixed(1)}<span class="stat-unit">km</span></div>
                    </div>
                    <div class="stat-card" style="--color-start: var(--purple); --color-end: #9b51e0;">
                        <div class="stat-label">Avg Duration</div>
                        <div class="stat-value">${stats.avgDuration}<span class="stat-unit">min</span></div>
                    </div>
                `;
            },

            updateChart() {
                const canvas = document.getElementById('activity-chart');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                const chartType = document.getElementById('chart-type').value;

                // Get last 30 days
                const days = 30;
                const data = Array(days).fill(0);
                const labels = [];
                
                for (let i = days - 1; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                }

                // Aggregate data
                this.workouts.forEach(w => {
                    const workoutDate = new Date(w.date + 'T00:00:00');
                    const today = new Date();
                    const diffDays = Math.floor((today - workoutDate) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays >= 0 && diffDays < days) {
                        if (chartType === 'all' || w.type === chartType) {
                            data[days - 1 - diffDays] += w.duration;
                        }
                    }
                });

                // Clear and draw
                const dpr = window.devicePixelRatio || 1;
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * dpr;
                canvas.height = 300 * dpr;
                ctx.scale(dpr, dpr);
                ctx.clearRect(0, 0, rect.width, 300);

                const padding = { top: 20, right: 20, bottom: 40, left: 50 };
                const chartWidth = rect.width - padding.left - padding.right;
                const chartHeight = 300 - padding.top - padding.bottom;

                const maxValue = Math.max(...data, 1) * 1.2;
                const barWidth = chartWidth / days;

                // Draw bars
                data.forEach((value, i) => {
                    if (value > 0) {
                        const barHeight = (value / maxValue) * chartHeight;
                        const x = padding.left + (i * barWidth);
                        const y = padding.top + chartHeight - barHeight;

                        // Gradient
                        const gradient = ctx.createLinearGradient(0, y, 0, padding.top + chartHeight);
                        gradient.addColorStop(0, 'rgba(10, 132, 255, 0.8)');
                        gradient.addColorStop(1, 'rgba(10, 132, 255, 0.2)');

                        ctx.fillStyle = gradient;
                        ctx.fillRect(x + 2, y, barWidth - 4, barHeight);
                    }
                });

                // Draw axes
                ctx.strokeStyle = 'rgba(84, 84, 88, 0.6)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(padding.left, padding.top);
                ctx.lineTo(padding.left, padding.top + chartHeight);
                ctx.lineTo(padding.left + chartWidth, padding.top + chartHeight);
                ctx.stroke();

                // Labels (every 5 days)
                ctx.fillStyle = 'rgba(235, 235, 245, 0.6)';
                ctx.font = '11px -apple-system';
                ctx.textAlign = 'center';
                
                for (let i = 0; i < days; i += 5) {
                    const x = padding.left + (i * barWidth) + (barWidth / 2);
                    ctx.fillText(labels[i], x, padding.top + chartHeight + 20);
                }

                // Show message if no data
                if (data.every(v => v === 0)) {
                    ctx.fillStyle = 'rgba(235, 235, 245, 0.6)';
                    ctx.font = '14px -apple-system';
                    ctx.textAlign = 'center';
                    ctx.fillText('No workout data for this period', rect.width / 2, 150);
                }
            },

            updateBreakdown() {
                const tbody = document.querySelector('#breakdown-table tbody');
                const breakdown = {};

                this.workouts.forEach(w => {
                    if (!breakdown[w.type]) {
                        breakdown[w.type] = { count: 0, totalTime: 0 };
                    }
                    breakdown[w.type].count++;
                    breakdown[w.type].totalTime += w.duration;
                });

                const sorted = Object.entries(breakdown).sort((a, b) => b[1].count - a[1].count);

                if (sorted.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; color: var(--text-secondary); padding: 40px;">
                                No workout data available
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = sorted.map(([type, data]) => {
                    const avgDuration = Math.round(data.totalTime / data.count);
                    const badgeClass = `badge-${type.toLowerCase()}`;
                    
                    return `
                        <tr>
                            <td><span class="badge ${badgeClass}">${type}</span></td>
                            <td>${data.count}</td>
                            <td>${data.totalTime} min</td>
                            <td>${avgDuration} min</td>
                        </tr>
                    `;
                }).join('');
            },

            // ==================== WORKOUT PREP ====================
            updatePrepUI() {
                const sport = document.getElementById('prep-sport').value;
                const target = document.getElementById('step-target').value;
                const container = document.getElementById('step-intensity-fields');
                const label = document.getElementById('step-value-label');

                // Update primary label
                if (target === 'time') {
                    label.textContent = 'Duration (minutes)';
                } else {
                    label.textContent = sport === 'Rowing' ? 'Distance (meters)' : 'Distance (km)';
                }

                // Intensity fields
                const fields = {
                    'Running': `
                        <div class="form-group mb-2">
                            <label class="form-label">Pace (min/km)</label>
                            <input type="number" class="form-input" id="step-intensity-pace" step="0.01" placeholder="5.30">
                        </div>
                    `,
                    'Cycling': `
                        <div class="form-group mb-2">
                            <label class="form-label">Speed (km/h)</label>
                            <input type="number" class="form-input" id="step-intensity-speed" step="0.1" placeholder="25">
                        </div>
                    `,
                    'Rowing': `
                        <div class="form-group mb-2">
                            <label class="form-label">Split (min/500m)</label>
                            <input type="number" class="form-input" id="step-intensity-split" step="0.01" placeholder="2.00">
                        </div>
                    `
                };

                container.innerHTML = fields[sport] || '';
                
                // Re-attach listeners
                const intensityInput = container.querySelector('input');
                if (intensityInput) {
                    intensityInput.addEventListener('input', () => this.updateStepPreview());
                }

                this.updateStepPreview();
            },

            updateStepPreview() {
                const sport = document.getElementById('prep-sport').value;
                const target = document.getElementById('step-target').value;
                const value = parseFloat(document.getElementById('step-value').value);
                const preview = document.getElementById('step-preview');

                if (!value) {
                    preview.textContent = 'Enter values to see preview';
                    return;
                }

                let result = '';

                if (sport === 'Running') {
                    const pace = parseFloat(document.getElementById('step-intensity-pace')?.value);
                    if (target === 'time' && pace) {
                        const dist = value / pace;
                        result = `${value} min → ~${dist.toFixed(2)} km @ ${pace} min/km`;
                    } else if (target === 'distance' && pace) {
                        const time = value * pace;
                        result = `${value} km → ~${time.toFixed(1)} min @ ${pace} min/km`;
                    }
                } else if (sport === 'Cycling') {
                    const speed = parseFloat(document.getElementById('step-intensity-speed')?.value);
                    if (target === 'time' && speed) {
                        const dist = speed * (value / 60);
                        result = `${value} min → ~${dist.toFixed(2)} km @ ${speed} km/h`;
                    } else if (target === 'distance' && speed) {
                        const time = (value / speed) * 60;
                        result = `${value} km → ~${time.toFixed(1)} min @ ${speed} km/h`;
                    }
                } else if (sport === 'Rowing') {
                    const split = parseFloat(document.getElementById('step-intensity-split')?.value);
                    if (target === 'time' && split) {
                        const meters = (value / split) * 500;
                        result = `${value} min → ~${Math.round(meters)} m @ ${split}/500m`;
                    } else if (target === 'distance' && split) {
                        const time = (value / 500) * split;
                        result = `${value} m → ~${time.toFixed(1)} min @ ${split}/500m`;
                    }
                }

                preview.textContent = result || 'Enter intensity to calculate';
            },

            addPrepStep() {
                const sport = document.getElementById('prep-sport').value;
                const phase = document.getElementById('step-phase').value;
                const target = document.getElementById('step-target').value;
                const value = parseFloat(document.getElementById('step-value').value);

                if (!value) {
                    alert('Please enter a value');
                    return;
                }

                const step = {
                    phase,
                    sport,
                    target,
                    value,
                    duration: 0,
                    distance: 0,
                    display: ''
                };

                // Calculate duration and display
                if (sport === 'Running') {
                    const pace = parseFloat(document.getElementById('step-intensity-pace')?.value);
                    if (target === 'time') {
                        step.duration = value * 60;
                        step.distance = pace ? value / pace : 0;
                        step.display = `${value} min${pace ? ` @ ${pace} min/km` : ''}`;
                    } else {
                        step.distance = value;
                        step.duration = pace ? value * pace * 60 : value * 6 * 60;
                        step.display = `${value} km${pace ? ` @ ${pace} min/km` : ''}`;
                    }
                } else if (sport === 'Cycling') {
                    const speed = parseFloat(document.getElementById('step-intensity-speed')?.value);
                    if (target === 'time') {
                        step.duration = value * 60;
                        step.distance = speed ? speed * (value / 60) : 0;
                        step.display = `${value} min${speed ? ` @ ${speed} km/h` : ''}`;
                    } else {
                        step.distance = value;
                        step.duration = speed ? (value / speed) * 60 * 60 : (value / 20) * 60 * 60;
                        step.display = `${value} km${speed ? ` @ ${speed} km/h` : ''}`;
                    }
                } else if (sport === 'Rowing') {
                    const split = parseFloat(document.getElementById('step-intensity-split')?.value);
                    if (target === 'time') {
                        step.duration = value * 60;
                        step.distance = split ? (value / split) * 500 / 1000 : 0;
                        step.display = `${value} min${split ? ` @ ${split}/500m` : ''}`;
                    } else {
                        step.distance = value / 1000;
                        step.duration = split ? (value / 500) * split * 60 : (value / 500) * 2.5 * 60;
                        step.display = `${value} m${split ? ` @ ${split}/500m` : ''}`;
                    }
                }

                this.prepSteps.push(step);
                this.renderPrepSteps();

                // Clear inputs
                document.getElementById('step-value').value = '';
                const intensityInput = document.querySelector('#step-intensity-fields input');
                if (intensityInput) intensityInput.value = '';
                this.updateStepPreview();
            },

            removePrepStep(index) {
                this.prepSteps.splice(index, 1);
                this.renderPrepSteps();
            },

            clearPlan() {
                if (this.prepSteps.length === 0) return;
                if (!confirm('Clear all steps?')) return;
                
                this.stopWorkout();
                this.prepSteps = [];
                this.renderPrepSteps();
            },

            renderPrepSteps() {
                const container = document.getElementById('prep-step-list');
                
                if (this.prepSteps.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-clipboard-list"></i>
                            <p>Add steps to build your workout</p>
                        </div>
                    `;
                    document.getElementById('prep-total-time').textContent = '0';
                    document.getElementById('prep-total-distance').textContent = '0 km estimated';
                    return;
                }

                const totalTime = this.prepSteps.reduce((sum, s) => sum + s.duration, 0);
                const totalDistance = this.prepSteps.reduce((sum, s) => sum + s.distance, 0);

                document.getElementById('prep-total-time').textContent = Math.round(totalTime / 60);
                document.getElementById('prep-total-distance').textContent = `${totalDistance.toFixed(2)} km estimated`;

                container.innerHTML = this.prepSteps.map((step, i) => {
                    const phaseLabels = {
                        warmup: 'Warm Up',
                        work: 'Work',
                        rest: 'Rest',
                        cooldown: 'Cool Down'
                    };

                    return `
                        <div class="step-item ${step.phase}" id="step-${i}">
                            <div class="step-info">
                                <div class="step-phase">${step.phase.toUpperCase()}</div>
                                <div class="step-title">${phaseLabels[step.phase]}</div>
                                <div class="step-detail">${step.display}</div>
                            </div>
                            <button class="btn btn-icon btn-danger" onclick="app.removePrepStep(${i})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                }).join('');
            },

            // ==================== WORKOUT PLAYER ====================
            togglePlay() {
                if (this.prepSteps.length === 0) {
                    alert('Add steps first!');
                    return;
                }

                if (this.player.isPlaying) {
                    this.pauseWorkout();
                } else {
                    this.startWorkout();
                }
            },

            startWorkout() {
                this.player.isPlaying = true;
                
                // Initialize first step if needed
                if (this.player.timeRemaining === 0) {
                    this.initStep(0);
                }

                // Update UI
                document.getElementById('play-icon').className = 'fas fa-pause';
                document.getElementById('play-text').textContent = 'Pause';
                document.getElementById('player-controls').classList.remove('hidden');

                // Start timer
                this.player.interval = setInterval(() => this.tick(), 1000);
            },

            pauseWorkout() {
                this.player.isPlaying = false;
                clearInterval(this.player.interval);
                
                document.getElementById('play-icon').className = 'fas fa-play';
                document.getElementById('play-text').textContent = 'Resume';
                document.getElementById('player-status').textContent = 'Paused';
            },

            stopWorkout() {
                this.player.isPlaying = false;
                this.player.currentStep = 0;
                this.player.timeRemaining = 0;
                clearInterval(this.player.interval);

                document.getElementById('play-icon').className = 'fas fa-play';
                document.getElementById('play-text').textContent = 'Start Workout';
                document.getElementById('player-controls').classList.add('hidden');
                document.getElementById('player-status').textContent = 'Ready to start';
                document.getElementById('play-btn').style.setProperty('--progress', '0%');

                // Remove active class
                document.querySelectorAll('.step-item').forEach(el => {
                    el.classList.remove('active');
                });
            },

            initStep(index) {
                if (index >= this.prepSteps.length) {
                    this.finishWorkout();
                    return;
                }

                this.player.currentStep = index;
                const step = this.prepSteps[index];
                this.player.timeRemaining = step.duration;
                this.player.totalTime = step.duration;

                // Highlight step
                document.querySelectorAll('.step-item').forEach((el, i) => {
                    el.classList.toggle('active', i === index);
                });

                // Scroll to step
                const stepEl = document.getElementById(`step-${index}`);
                if (stepEl) {
                    stepEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                this.updatePlayerUI();
            },

            tick() {
                if (this.player.timeRemaining > 0) {
                    this.player.timeRemaining--;
                    this.updatePlayerUI();
                } else {
                    // Move to next step
                    this.initStep(this.player.currentStep + 1);
                }
            },

            updatePlayerUI() {
                const step = this.prepSteps[this.player.currentStep];
                const mins = Math.floor(this.player.timeRemaining / 60);
                const secs = Math.round(this.player.timeRemaining % 60);
                const timeStr = `${mins}:${secs.toString().padStart(2, '0')}`;

                const phaseLabels = {
                    warmup: 'Warm Up',
                    work: 'Work',
                    rest: 'Rest',
                    cooldown: 'Cool Down'
                };

                document.getElementById('player-status').innerHTML = `
                    <strong style="color: var(--primary)">${phaseLabels[step.phase]}</strong><br>
                    ${timeStr} remaining
                `;

                // Update progress bar
                const progress = ((this.player.totalTime - this.player.timeRemaining) / this.player.totalTime) * 100;
                document.getElementById('play-btn').style.setProperty('--progress', `${progress}%`);
            },

            skipStep(direction) {
                const newIndex = this.player.currentStep + direction;
                if (newIndex >= 0 && newIndex < this.prepSteps.length) {
                    this.initStep(newIndex);
                } else if (newIndex >= this.prepSteps.length) {
                    this.finishWorkout();
                }
            },

            finishWorkout() {
                this.stopWorkout();
                document.getElementById('player-status').innerHTML = '<strong style="color: var(--success)">Workout Complete! 🎉</strong>';
                document.getElementById('play-btn').style.setProperty('--progress', '100%');
            },

            // ==================== IMPORT/EXPORT ====================
            exportData() {
                const data = JSON.stringify(this.workouts, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `workout-tracker-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },

            importData() {
                document.getElementById('import-file').click();
            },

            handleImport(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (Array.isArray(data)) {
                            if (confirm('This will replace all existing data. Continue?')) {
                                this.workouts = data;
                                this.saveData();
                                this.renderWorkoutList();
                                if (document.getElementById('view-analytics').classList.contains('active')) {
                                    this.updateAnalytics();
                                }
                                alert('Import successful!');
                            }
                        } else {
                            alert('Invalid file format');
                        }
                    } catch (err) {
                        alert('Error reading file');
                    }
                    event.target.value = '';
                };
                reader.readAsText(file);
            }
        };

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
