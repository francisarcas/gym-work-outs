<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Workout Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Apple Style Dark Mode Variables */
        :root {
            /* Core Colors */
            --primary: #0A84FF; /* Apple Blue */
            --danger: #FF453A; /* Apple Red */
            --success: #32D74B; /* Apple Green */
            --warning: #FFD60A; /* Apple Yellow */
            --info: #64D2FF; /* Apple Light Blue */

            /* Neutral Colors - Dark Mode */
            --bg-color: #000000; /* Pure Black for OLED */
            --card-bg: rgba(28, 28, 30, 0.9); /* Slightly transparent dark gray for cards */
            --input-bg: rgba(44, 44, 46, 0.9); /* Slightly transparent medium dark gray for inputs */
            --border-color: rgba(68, 68, 70, 0.6); /* Subtle border for dark mode */
            --text-main: #FFFFFF; /* Pure White text */
            --text-secondary: #EBEBF599; /* Light gray for secondary text, 60% opacity */
            --text-placeholder: #EBEBF54D; /* Lighter gray for placeholders, 30% opacity */
            --row-hover: rgba(255, 255, 255, 0.08); /* Subtle hover for table rows */
            --gradient-start: #0A84FF; /* Consistent with --primary */
            --gradient-end: #5856D6; /* A slightly deeper blue/purple */

            /* Component Radii */
            --radius-sm: 8px; /* Small elements like nav buttons */
            --radius-md: 12px; /* Inputs, small buttons */
            --radius-lg: 16px; /* Cards, main buttons */

            /* Shadows */
            --shadow-card: 0 4px 12px rgba(0, 0, 0, 0.4);
            --shadow-btn: 0 2px 6px rgba(0, 0, 0, 0.3);
            --shadow-input-focus: 0 0 0 3px rgba(10, 132, 255, 0.5); /* Primary color glow */
        }

        /* Base Styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.4;
        }

        .container { max-width: 900px; margin: 0 auto; }

        /* Card Styles */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            backdrop-filter: blur(20px) saturate(180%); /* Enhanced blur */
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            box-shadow: var(--shadow-card);
            position: relative;
            overflow: hidden; /* Ensures content respects border-radius */
        }
        
        /* Headings */
        h1 { font-size: 28px; margin: 0; font-weight: 700; }
        h2 { font-size: 20px; margin-bottom: 18px; font-weight: 600; color: var(--text-main); }
        h3 { font-size: 17px; margin-bottom: 14px; font-weight: 600; color: var(--text-main); }


        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-top-row {
            display: flex;
            align-items: center;
            gap: 20px; /* Increased gap */
            flex: 1;
        }

        .app-title {
            font-size: 28px; /* Slightly larger */
            font-weight: 800; /* Bolder */
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px; /* Increased gap for icons */
            background: linear-gradient(to right, var(--primary), var(--gradient-end)); /* Use gradient vars */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }
        .app-title i {
            font-size: 24px; /* Adjust icon size */
        }

        /* NAVIGATION TABS (Segmented Control) */
        .nav-tabs {
            display: inline-flex;
            background: rgba(118, 118, 128, 0.24); /* Darker, more prominent background */
            padding: 4px;
            border-radius: var(--radius-sm);
            margin-right: auto;
        }

        .nav-btn {
            border: none;
            background: none;
            padding: 8px 18px; /* Slightly more padding */
            font-size: 14px; /* Slightly larger font */
            font-weight: 600;
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--text-secondary); /* Muted text color */
            transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
            -webkit-appearance: none; /* Remove default button styles */
            -moz-appearance: none;
            appearance: none;
        }

        .nav-btn.active {
            background: var(--card-bg); /* Use card background for active state */
            color: var(--text-main); /* White text for active */
            box-shadow: 0 1px 3px rgba(0,0,0,0.2), inset 0 0 0 0.5px rgba(255,255,255,0.1); /* Subtle inner and outer shadow */
            font-weight: 700;
        }
        .nav-btn:not(.active):hover {
            color: var(--text-main); /* Slightly brighten text on hover for inactive buttons */
        }

        /* BUTTONS */
        .btn-primary {
            background: linear-gradient(180deg, var(--primary), var(--gradient-end)); /* Subtle gradient */
            color: #fff;
            border: none;
            padding: 14px 20px; /* More generous padding */
            border-radius: var(--radius-md);
            font-size: 16px; /* Larger font */
            font-weight: 700; /* Bolder */
            cursor: pointer;
            width: 100%;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-btn);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px); /* Subtle lift effect */
            box-shadow: 0 44px 8px rgba(0,0,0,0.4);
        }
        .btn-primary:active {
            opacity: 0.8;
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.3) inset; /* Pressed effect */
        }

        .btn-secondary {
            background: rgba(10, 132, 255, 0.15); /* Primary color with transparency */
            color: var(--primary);
            border: 1px solid rgba(10, 132, 255, 0.3); /* Subtle border matching primary */
            padding: 10px 16px;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: background 0.2s ease, border-color 0.2s ease;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .btn-secondary:hover {
            background: rgba(10, 132, 255, 0.25);
            border-color: rgba(10, 132, 255, 0.5);
        }
        .btn-secondary:active {
            background: rgba(10, 132, 255, 0.35);
            border-color: rgba(10, 132, 255, 0.6);
        }

        .btn-danger-text {
            color: var(--danger);
            background: rgba(255, 69, 58, 0.15);
            border-color: rgba(255, 69, 58, 0.3);
        }
        .btn-danger-text:hover {
             background: rgba(255, 69, 58, 0.25);
             border-color: rgba(255, 69, 58, 0.5);
        }
        .btn-danger-text:active {
            background: rgba(255, 69, 58, 0.35);
            border-color: rgba(255, 69, 58, 0.6);
        }

        .btn-add-step {
            background: var(--success);
            color: white;
            border: none;
            padding: 12px; /* Slightly more padding */
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s ease, transform 0.2s ease;
            box-shadow: var(--shadow-btn);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .btn-add-step:hover {
            background: #28a745; /* Slightly darker green */
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }
        .btn-add-step:active {
            background: #218838; /* Even darker green */
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.3) inset;
        }
        .btn-add-step i { margin-right: 6px; }


        /* Form & Inputs */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 16px; }
        .form-group { display: flex; flex-direction: column; }
        
        label {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 8px; /* Increased margin */
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.6px;
            opacity: 0.8;
        }
        
        input, select, textarea {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 10px 14px; /* More padding */
            border-radius: var(--radius-md); /* Consistent radius */
            font-size: 15px;
            outline: none;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            -webkit-appearance: none; /* Remove default styles for consistency */
            -moz-appearance: none;
            appearance: none;
        }
        input::placeholder, textarea::placeholder {
            color: var(--text-placeholder);
            opacity: 1; /* Firefox default is lower */
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: var(--shadow-input-focus);
        }
        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23EBEBF599'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 30px; /* Make space for the custom arrow */
        }
        select option {
            background: var(--input-bg); /* Ensure options are dark */
            color: var(--text-main);
        }
        textarea {
            resize: vertical;
            min-height: 60px;
        }

        /* Styling for the box around form sections */
        .form-section-box {
            padding: 20px; /* More padding */
            background: rgba(128,128,128,0.08); /* Lighter background for differentiation */
            border-radius: var(--radius-md);
            border: 1px dashed var(--border-color); /* Dashed border for distinct sections */
            margin-bottom: 18px; /* Increased margin */
        }

        /* Dynamic Fields */
        .field-group { display: none; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; }
        .field-group.active { display: grid; }


        /* Tables */
        table {
            width: 100%;
            border-collapse: separate; /* Allows border-radius on table rows */
            border-spacing: 0;
            min-width: 650px;
        }
        th {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            text-align: left;
            padding: 14px 12px; /* More padding */
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .date-row {
            background: rgba(128, 128, 128, 0.08); /* Slightly darker background */
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: background 0.2s ease;
        }
        .date-row td {
            padding: 14px 12px;
            border-bottom: 1px solid var(--border-color);
            position: relative; /* For the chevron icon */
        }
        .date-row:hover {
            background: var(--row-hover);
        }
        .date-row i {
            transition: transform 0.2s ease;
            color: var(--text-secondary);
            font-size: 10px;
        }
        .date-row.expanded i {
            transform: rotate(90deg);
        }
        
        .workout-row { cursor: pointer; display: none; transition: background 0.2s ease; }
        .workout-row.visible { display: table-row; }
        .workout-row td {
            padding: 12px; /* Slightly less padding than date row */
            border-bottom: 1px solid var(--border-color);
            color: var(--text-main);
        }
        .workout-row:hover {
            background: var(--row-hover);
        }
        
        th:last-child, td:last-child { text-align: right; padding-right: 12px; }

        .details-row { display: none; background: rgba(128, 128, 128, 0.05); }
        .details-row.visible { display: table-row; }
        .details-content {
            padding: 12px 12px 12px 40px;
            font-size: 13px;
            color: var(--text-secondary);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        .details-content b { color: var(--text-main); font-weight: 500; } /* Make labels slightly more prominent */

        .tag {
            padding: 5px 10px; /* Slightly more vertical padding */
            border-radius: 999px; /* Pill shape */
            font-size: 11px; /* Smaller font for tags */
            font-weight: 600;
            display: inline-block;
            min-width: 70px;
            text-align: center;
            opacity: 0.9;
            letter-spacing: 0.2px;
        }
        .type-running, .type-cycling { color: var(--warning); background: rgba(255,199,0,0.18); } /* Apple Yellow */
        .type-swimming, .type-rowing { color: var(--primary); background: rgba(10,132,255,0.18); } /* Apple Blue */
        .type-weights, .type-strength, .type-core { color: #BF5AF2; background: rgba(191,90,242,0.18); } /* Apple Purple */
        .type-yoga, .type-pilates, .type-hiit, .type-other { color: var(--success); background: rgba(48,209,88,0.18); } /* Apple Green */

        /* Empty State */
        .empty {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-style: italic;
            border-top: 1px solid var(--border-color);
            margin-top: 10px;
            font-size: 15px;
        }

        /* --- DASHBOARD STYLES --- */
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-bottom: 24px; }
        
        .stat-card {
            padding: 16px; /* More padding */
            border-radius: var(--radius-md);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 70px; /* Taller cards */
            box-shadow: var(--shadow-btn); /* Use button shadow for consistency */
            overflow: hidden;
            position: relative;
        }
        /* Subtle texture overlay for cards */
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(rgba(255,255,255,0.05), rgba(0,0,0,0.05));
            pointer-events: none;
            z-index: 1;
        }
        
        .stat-card.orange { background: linear-gradient(135deg, #FF9500, #FF3B30); }
        .stat-card.blue { background: linear-gradient(135deg, var(--primary), var(--gradient-end)); }
        .stat-card.purple { background: linear-gradient(135deg, #BF5AF2, #AF52DE); }
        .stat-card.green { background: linear-gradient(135deg, var(--success), #30B0C7); }
        .stat-card.gray { background: linear-gradient(135deg, #8E8E93, #636366); }

        .stat-label { font-size: 12px; text-transform: uppercase; opacity: 0.8; font-weight: 600; letter-spacing: 0.5px; z-index: 2; position: relative; }
        .stat-value { font-size: 24px; font-weight: 700; z-index: 2; position: relative; }
        .stat-unit { font-size: 14px; font-weight: 500; opacity: 0.9; z-index: 2; position: relative; }

        canvas { width: 100%; height: 280px; margin-bottom: 20px; }
        
        .bin {
            color: var(--danger);
            font-size: 16px; /* Slightly larger icon */
            border:none;
            background: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%; /* Circular hit area */
            transition: background 0.2s ease, color 0.2s ease;
        }
        .bin:hover {
            background: rgba(255, 69, 58, 0.1);
            color: var(--danger);
        }
        .bin:active {
            background: rgba(255, 69, 58, 0.2);
        }

        /* --- DISTRIBUTION CHART STYLES --- */
        .dist-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .dist-wrapper { width: 100%; }
        #distChart { width: 100%; height: 320px; }
        .dist-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 16px 24px; /* Increased horizontal gap */
            margin-top: 20px; /* More margin */
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        .legend-item { display: flex; align-items: center; font-size: 14px; }
        .legend-dot {
            width: 12px; /* Larger dot */
            height: 12px;
            border-radius: 50%;
            margin-right: 10px; /* More space */
            flex-shrink: 0;
        }
        .legend-info { display: flex; flex-direction: column; }
        .legend-name { font-weight: 600; color: var(--text-main); }
        .legend-stats { font-size: 12px; color: var(--text-secondary); }

        /* --- PREP BUILDER STYLES --- */
        .prep-container { display: none; }
        .prep-container.active { display: block; }
        
        .builder-grid { display: grid; grid-template-columns: 1fr 300px; gap: 24px; /* More gap */ }
        @media (max-width: 800px) { .builder-grid { grid-template-columns: 1fr; } }

        .step-list { list-style: none; padding: 0; margin: 0; }
        .step-item {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            overflow: hidden; /* For the color bar */
        }
        
        .step-item::before {
            content:'';
            position: absolute;
            left:0;
            top: 0; /* Full height bar */
            bottom: 0;
            width: 6px; /* Wider bar */
            border-radius: 0; /* No radius on the bar itself */
        }
        .step-warmup::before { background: var(--success); }
        .step-work::before { background: var(--warning); }
        .step-cooldown::before { background: var(--primary); }
        .step-rest::before { background: var(--text-secondary); } /* Use secondary text color for rest */

        .step-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding-left: 10px; /* Offset for the color bar */
        }
        .step-title { font-weight: 700; font-size: 16px; color: var(--text-main); }
        .step-detail { font-size: 13px; color: var(--text-secondary); }
        .step-tag {
            font-size: 10px;
            text-transform: uppercase;
            font-weight: 700;
            opacity: 0.7;
            color: var(--primary); /* Use primary for tag highlight */
            letter-spacing: 0.5px;
        }

        .add-panel {
            background: rgba(128,128,128,0.06); /* Slightly lighter than card-bg */
            padding: 20px;
            border-radius: var(--radius-md);
            border: 1px dashed var(--border-color);
        }
        .add-title {
            font-size: 12px;
            font-weight: 700; /* Bolder */
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 16px; /* More margin */
            letter-spacing: 0.8px;
            opacity: 0.9;
        }
        
        .summary-box {
            text-align: center;
            padding: 24px; /* More padding */
            background: linear-gradient(135deg, var(--primary), var(--gradient-end));
            color: white;
            border-radius: var(--radius-md);
            margin-bottom: 24px;
            box-shadow: var(--shadow-card);
            position: relative;
            overflow: hidden;
        }
        .summary-box::before { /* Subtle texture */
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(rgba(255,255,255,0.08), rgba(0,0,0,0.08));
            pointer-events: none;
            z-index: 1;
        }
        .summary-total { font-size: 36px; font-weight: 800; z-index: 2; position: relative; }
        .summary-label { font-size: 14px; font-weight: 600; opacity: 0.9; letter-spacing: 0.5px; z-index: 2; position: relative; }
        .summary-box #prep-total-distance { font-size: 13px; margin-top: 8px; opacity: 0.8; z-index: 2; position: relative; }


        .views-section { display: none; }
        .views-section.visible { display: block; }
        
        /* --- New Styling for Import/Export Buttons --- */
        .header-actions {
            display: flex;
            gap: 12px; /* Slightly more gap */
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        /* --- PREP TRANSPORT CONTROLS --- */
.prep-transport{
    display:flex;
    align-items:center;
    gap:12px;
    flex-wrap:wrap;
}

.btn-full{
    width: 100%;
}

/* Transport buttons */
.btn-transport{
    background: rgba(142, 142, 147, 0.18);
    color: var(--text-secondary);
    border: 1px solid rgba(142, 142, 147, 0.35);
    padding: 12px 14px;
    border-radius: var(--radius-md);
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    -webkit-appearance:none;
    appearance:none;
}

.btn-transport:hover{
    background: rgba(142, 142, 147, 0.26);
    border-color: rgba(142, 142, 147, 0.55);
    color: var(--text-main);
}

.btn-transport:active{
    background: rgba(142, 142, 147, 0.32);
}
.btn-transport-full{
    width: 100%;
    margin-bottom: 12px;
}
/* Hidden by default; shown only when playing */
.prep-active-controls{
    display: none;
    width: 100%;
    gap: 12px;
    margin-bottom: 12px;
}

.prep-active-controls.active{
    display: flex;
}

/* Make the three control buttons share the row nicely */
.prep-active-controls .btn-transport{
    flex: 1;
}

.prep-clear{
    margin-top: 16px; /* keep clear at bottom */
}






        @media (max-width: 768px) {
            .header-actions {
                width: 100%;
                justify-content: center;
            }
            .header-actions .btn-secondary {
                flex-grow: 1;
            }
        }
        
        /* --- New Styling for Print/Clear Buttons in Prep View --- */
        .prep-actions {
            display: flex;
            gap: 12px;
            flex-direction: row;
            justify-content: center;
            margin-top: 16px;
        }
        .prep-actions .btn-secondary {
             flex: 1;
        }
        @media (max-width: 768px) {
            .prep-actions {
                flex-direction: column;
            }
        }

        /* --- MOBILE RESPONSIVENESS --- */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .header {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }

            .header-top-row {
                flex-direction: column;
                width: 100%;
                gap: 15px;
                flex: auto;
            }

            .nav-tabs {
                margin-right: 0;
                justify-content: center;
                width: 100%;
            }

            table {
                min-width: unset;
            }
            th, td {
                padding: 12px 8px; /* Adjust padding for smaller screens */
            }

            .details-content {
                padding: 10px 10px 10px 20px;
                grid-template-columns: 1fr;
            }
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .dashboard-header h2, .dashboard-header select {
                width: 100%;
            }
            .dist-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .dist-header h2, .dist-header select {
                width: 100%;
            }
            .form-grid {
                grid-template-columns: 1fr; /* Stack form inputs vertically on small screens */
            }
            .form-section-box {
                padding: 16px; /* Less padding on mobile */
            }
        }
    </style>
</head>

<body>
<div class="container">

    <div class="header">
        <div class="header-top-row">
            <div class="app-title">
                <i class="fa-solid fa-dumbbell"></i>
                <i class="fa-solid fa-person-running"></i>
                <i class="fa-solid fa-person-biking"></i>
                <i class="fa-solid fa-person-swimming"></i>
            </div>

            <div class="nav-tabs">
                <button class="nav-btn active" onclick="switchView('tracker')">Tracker</button>
                <button class="nav-btn" onclick="switchView('prep')">Workout Prep</button>
            </div>
        </div>
        
        <div class="header-actions">
            <button class="btn-secondary" onclick="importFromJson()">
                <i class="fa-solid fa-file-arrow-up"></i> Import
            </button>
            <button class="btn-secondary" onclick="exportToJson()">
                <i class="fa-solid fa-file-arrow-down"></i> Export
            </button>
        </div>
    </div>

    <!-- Hidden file input for import functionality -->
    <input type="file" id="importFileInput" accept="application/json" style="display:none;">

    <!-- ========================= TRACKER VIEW ========================= -->
    <div id="view-tracker" class="views-section visible">
        <!-- LOG ACTIVITY CARD -->
        <div class="card">
            <h2>Log Activity</h2>
            <form id="workoutForm">
                <!-- Apply form-section-box to form-grid -->
                <div class="form-grid form-section-box">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="date" required>
                    </div>
                    <div class="form-group">
                        <label>Activity</label>
                        <select id="type" required>
                            <option>Running</option>
                            <option>Swimming</option>
                            <option>Weights</option>
                            <option>Strength</option>
                            <option>Core</option>
                            <option>Cycling</option>
                            <option>Rowing</option>
                            <option>Yoga</option>
                            <option>Pilates</option>
                            <option>HIIT</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Duration (min)</label>
                        <input type="number" id="duration" min="1" required>
                    </div>
                </div>

                <!-- Dynamic Fields - also apply form-section-box -->
                <div id="dynamicFields" class="form-section-box">
                    <div id="fields-running" class="field-group active">
                        <input type="number" step="0.01" placeholder="Distance (km)" data-label="Distance" id="run-dist">
                        <input type="number" step="0.01" placeholder="Pace (min/km)" data-label="Pace" id="run-pace">
                        <input type="text" placeholder="Intervals (e.g. 5x1km)" data-label="Intervals">
                    </div>
                    <div id="fields-cycling" class="field-group">
                        <input type="number" step="0.01" placeholder="Distance (km)" data-label="Distance">
                        <input type="number" step="0.1" placeholder="Avg Speed (km/h)" data-label="Avg Speed">
                    </div>
                    <div id="fields-rowing" class="field-group">
                        <input type="number" step="0.01" placeholder="Distance (km)" data-label="Distance">
                        <input type="number" placeholder="Stroke rate" data-label="Stroke Rate">
                    </div>
                    <div id="fields-swimming" class="field-group">
                        <input type="number" placeholder="Laps" data-label="Laps">
                        <input type="number" value="25" placeholder="Pool size (m)" data-label="Pool Size">
                    </div>
                    
                    <!-- Expanded Weights Section -->
                    <div id="fields-weights" class="field-group">
                        <select data-label="Exercise">
                            <option value="">Select Exercise...</option>
                            
                            <optgroup label="Lower Body (Push / Squat)">
                                <option>Back Squat</option>
                                <option>Front Squat</option>
                                <option>Goblet Squat</option>
                                <option>Overhead Squat</option>
                                <option>Bulgarian Split Squat</option>
                                <option>Leg Press</option>
                                <option>Hack Squat</option>
                                <option>Lunges</option>
                                <option>Step-ups</option>
                            </optgroup>
                            
                            <optgroup label="Lower Body (Hinge / Posterior)">
                                <option>Conventional Deadlift</option>
                                <option>Romanian Deadlift</option>
                                <option>Sumo Deadlift</option>
                                <option>Trap Bar Deadlift</option>
                                <option>Stiff-Legged Deadlift</option>
                                <option>Good Mornings</option>
                                <option>Hip Thrust / Glute Bridge</option>
                                <option>Cable Pull-through</option>
                            </optgroup>

                            <optgroup label="Upper Body (Push)">
                                <option>Bench Press</option>
                                <option>Incline Bench Press</option>
                                <option>Decline Bench Press</option>
                                <option>Close-Grip Bench Press</option>
                                <option>Dumbbell/Cable Fly</option>
                                <option>Push-ups (Weighted)</option>
                                <option>Machine Chest Press</option>
                                <option>Overhead Press</option>
                                <option>Seated DB Shoulder Press</option>
                                <option>Arnold Press</option>
                                <option>Push Press</option>
                                <option>Lateral Raises</option>
                            </optgroup>

                            <optgroup label="Back / Pulling">
                                <option>Bent-Over Row</option>
                                <option>Single-Arm DB Row</option>
                                <option>Pendlay Row</option>
                                <option>Seated Cable Row</option>
                                <option>T-Bar Row</option>
                                <option>Lat Pulldown</option>
                                <option>Pull-ups / Chin-ups</option>
                                <option>Face Pulls</option>
                                <option>Shrugs</option>
                            </optgroup>

                            <optgroup label="Arms">
                                <option>Bicep Curl</option>
                                <option>Hammer Curl</option>
                                <option>Concentration Curl</option>
                                <option>Cable Curl</option>
                                <option>Tricep Extension</option>
                                <option>Tricep Dips</option>
                                <option>Tricep Pushdowns</option>
                                <option>Kickbacks</option>
                            </optgroup>

                            <optgroup label="Core / Abs">
                                <option>Weighted Plank</option>
                                <option>Ab Wheel Rollout</option>
                                <option>Cable Crunch</option>
                                <option>Hanging Leg Raises</option>
                                <option>Russian Twists</option>
                                <option>Dead Bugs</option>
                            </optgroup>
                        </select>
                        <input type="number" placeholder="Sets" data-label="Sets">
                        <input type="number" placeholder="Reps" data-label="Reps">
                        <input type="number" step="0.5" placeholder="Weight (kg)" data-label="Weight">
                    </div>

                    <div id="fields-strength" class="field-group">
                        <select data-label="Exercise">
                            <option value="">Select Strength Exercise...</option>
                            
                            <optgroup label="Lower Body – Squat Pattern (Quad Dominant)">
                                <option>Low-Bar Back Squat</option>
                                <option>High-Bar Back Squat</option>
                                <option>Front Squat</option>
                                <option>Paused Back Squat</option>
                                <option>Box Squat</option>
                                <option>Safety Bar Squat (SSB)</option>
                                <option>Tempo Squat</option>
                            </optgroup>
                            
                            <optgroup label="Upper Body – Horizontal Push (Bench Press Pattern)">
                                <option>Competition Bench Press (Paused)</option>
                                <option>Close-Grip Bench Press</option>
                                <option>Paused Bench Press</option>
                                <option>Board Press / Pin Press</option>
                                <option>Floor Press</option>
                                <option>Spoto Press</option>
                            </optgroup>
                            
                            <optgroup label="Lower Body – Hinge Pattern (Deadlift)">
                                <option>Conventional Deadlift</option>
                                <option>Sumo Deadlift</option>
                                <option>Deficit Deadlift</option>
                                <option>Paused Deadlift</option>
                                <option>Rack Pull</option>
                                <option>Block Pull</option>
                                <option>Trap Bar Deadlift</option>
                            </optgroup>
                            
                            <optgroup label="Upper Body – Vertical Push (Overhead Press Pattern)">
                                <option>Strict Standing Overhead Press / Military Press</option>
                                <option>Push Press</option>
                                <option>Seated Overhead Press</option>
                            </optgroup>
                            
                            <optgroup label="Pulling / Back Strength (Assistance for Balance)">
                                <option>Weighted Pull-ups / Chin-ups</option>
                                <option>Barbell Bent-Over Row</option>
                                <option>Pendlay Row</option>
                                <option>Heavy Barbell Shrugs</option>
                            </optgroup>
                            
                            <optgroup label="Core / Grip / Assistance for Strength">
                                <option>Heavy Ab Wheel Rollouts</option>
                                <option>Weighted Planks</option>
                                <option>Farmer's Walks / Heavy Carries</option>
                            </optgroup>
                        </select>

                        <input type="number" placeholder="Sets" data-label="Sets">
                        <input type="number" placeholder="Reps" data-label="Reps">
                        <input type="number" step="0.5" placeholder="Weight (kg)" data-label="Weight">
                    </div>

                    <div id="fields-core" class="field-group">
                        <input type="text" placeholder="Exercise name" data-label="Exercise">
                        <input type="number" placeholder="Sets" data-label="Sets">
                        <input type="text" placeholder="Reps / Time" data-label="Reps/Time">
                    </div>

                    <div id="fields-yoga" class="field-group">
                        <input type="text" placeholder="Style" data-label="Style">
                    </div>
                    <div id="fields-pilates" class="field-group">
                        <input type="text" placeholder="Focus" data-label="Focus">
                    </div>
                    <div id="fields-hiit" class="field-group">
                        <input type="text" placeholder="Format" data-label="Format">
                        <input type="number" placeholder="Rounds" data-label="Rounds">
                    </div>
                    <div id="fields-other" class="field-group">
                        <input type="text" placeholder="Style or focus" data-label="Details">
                    </div>
                </div>

                <div class="form-group" style="margin-bottom:16px;">
                    <label>Notes</label>
                    <textarea id="notes" rows="2"></textarea>
                </div>

                <button class="btn-primary">Log Workout</button>
            </form>
        </div>

        <!-- HISTORY CARD -->
        <div class="card">
            <h2>Recent History</h2>
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th style="width:40px;"></th>
                            <th>Date / Activity</th>
                            <th>Duration</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="workoutList"></tbody>
                </table>
                <div id="emptyState" class="empty">No workouts yet</div>
            </div>
        </div>

        <!-- DISTRIBUTION CARD -->
        <div class="card">
            <div class="dist-header">
                <h2 style="margin:0;">Workout Distribution</h2>
                <select id="distYearSelect" style="width: auto; margin:0;"></select>
            </div>
            <div class="dist-wrapper">
                <canvas id="distChart"></canvas>
                <div class="dist-legend" id="distLegend"></div>
            </div>
        </div>

        <!-- ANALYTICS CARD -->
        <div class="card">
            <div class="dashboard-header">
                <h2>Performance Analytics</h2>
                <select id="statsTypeSelect" style="width: auto;">
                    <option value="Running">Running</option>
                    <option value="Cycling">Cycling</option>
                    <option value="Weights">Weights</option>
                    <option value="Swimming">Swimming</option>
                    <option value="Rowing">Rowing</option>
                </select>
            </div>

            <div class="stat-grid" id="statCards"></div>
            <canvas id="statsChart"></canvas>

            <h3>Monthly Breakdown</h3>
            <div style="overflow-x:auto;">
                <table>
                    <thead id="statsTableHead"></thead>
                    <tbody id="statsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ========================= WORKOUT PREP VIEW ========================= -->
    <div id="view-prep" class="views-section">
        <div class="card">
            <div class="dashboard-header">
                <h2>Create Workout Plan</h2>
                <select id="prep-type" onchange="resetPrep()" style="width:auto;">
                    <option value="Running">Running</option>
                    <option value="Cycling">Cycling</option>
                    <option value="Rowing">Rowing</option>
                </select>
            </div>

            <div class="builder-grid">
                <!-- Left: The Plan -->
                <div>
                    <div class="summary-box">
                        <div id="prep-total-duration" class="summary-total">0</div>
                        <div class="summary-label">TOTAL MINUTES</div>
                        <div id="prep-total-distance" style="font-size:12px; margin-top:5px; opacity:0.8">0 km est.</div>
                    </div>
                    
                    <ul id="prep-list" class="step-list">
                        <!-- Steps go here -->
                        <div style="text-align:center; padding:30px; color:var(--text-secondary); border: 2px dashed var(--border-color); border-radius:var(--radius-md);">
                            Start adding steps to build your workout
                        </div>
                    </ul>
                </div>

                <!-- Right: The Controls -->
                <div>
                    <div class="add-panel">
                        <div class="add-title">Add a Step</div>
                        
                        <div class="form-group" style="margin-bottom:12px;">
                            <label>Phase</label>
                            <select id="step-phase">
                                <option value="warmup">Warm Up</option>
                                <option value="work">Active Interval / Run</option>
                                <option value="rest">Recovery / Rest</option>
                                <option value="cooldown">Cool Down</option>
                            </select>
                        </div>

                        <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:12px;">
                            <div class="form-group">
                                <label>Target Type</label>
                                <select id="step-target-type" onchange="togglePrepInputs()">
                                    <option value="time">Time</option>
                                    <option value="dist">Distance</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label id="step-val-label">Duration (min)</label>
                                <input type="number" id="step-val" value="10">
                            </div>
                        </div>

                        <div class="form-group" style="margin-bottom:16px;">
                            <label>Intensity / Pace</label>
                            <input type="text" id="step-intensity" placeholder="e.g. 5:30/km, Easy, Sprint">
                        </div>

                        <button class="btn-add-step" onclick="addPrepStep()">
                            <i class="fa-solid fa-plus"></i> Add to Plan
                        </button>
                    </div>

                    <div class="add-panel" style="margin-top:20px; border-style:solid; background:var(--card-bg);">
                        <div class="add-title">Actions</div>

                        <!-- Full-width Play/Pause -->
                        <button id="prepPlayBtn" class="btn-transport btn-transport-full" type="button" onclick="togglePrepPlay()">
                            <i class="fa-solid fa-play"></i>
                            <span>Play</span>
                        </button>

                        <!-- Hidden until Play is active -->
                        <div id="prepActiveControls" class="prep-active-controls">
                            <button class="btn-transport" type="button" onclick="prepStep(-1)" aria-label="Previous step">
                                <i class="fa-solid fa-forward-step" style="transform: scaleX(-1);"></i>
                            </button>

                            <button class="btn-transport" type="button" onclick="stopPrep()" aria-label="Stop">
                                <i class="fa-solid fa-circle-stop"></i>
                            </button>

                            <button class="btn-transport" type="button" onclick="prepStep(1)" aria-label="Next step">
                                <i class="fa-solid fa-forward-step"></i>
                            </button>
                        </div>

                        <!-- Full-width Clear All at bottom -->
                        <button class="btn-secondary btn-danger-text btn-full" type="button" onclick="resetPrep()">
                            Clear All
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
// --- GLOBAL NAVIGATION ---
function switchView(viewName) {
    // Buttons
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    if(viewName === 'tracker') document.querySelectorAll('.nav-btn')[0].classList.add('active');
    else document.querySelectorAll('.nav-btn')[1].classList.add('active');

    // Views
    document.querySelectorAll('.views-section').forEach(v => v.classList.remove('visible'));
    document.getElementById('view-' + viewName).classList.add('visible');
}

// --- DATA INITIALIZATION ---
let workouts = [];
try { 
    // Attempt to parse existing data, default to empty array if not found or parsing fails
    workouts = JSON.parse(localStorage.getItem('smartWorkouts')) || []; // Added || [] for robustness
} catch (e) { 
    console.error("Error parsing localStorage data:", e);
    workouts = []; // Fallback to empty array on error
}

// --- DOM ELEMENTS (TRACKER) ---
const form = document.getElementById('workoutForm');
const typeSelect = document.getElementById('type');
const statsTypeSelect = document.getElementById('statsTypeSelect');
const distYearSelect = document.getElementById('distYearSelect');
const canvas = document.getElementById('statsChart');
const ctx = canvas.getContext('2d');
const distCanvas = document.getElementById('distChart');
const distCtx = distCanvas.getContext('2d');
const importFileInput = document.getElementById('importFileInput');


// --- RUNNING AUTO CALC ELEMENTS ---
const globalDuration = document.getElementById('duration');
const runDistInput = document.getElementById('run-dist');
const runPaceInput = document.getElementById('run-pace'); 

// Color Palette - Updated to use new Apple-style colors
const workoutColors = {
    'Running': '#FF9500', 'Cycling': '#FF9500', /* Apple Orange */
    'Swimming': '#0A84FF', 'Rowing': '#0A84FF', /* Apple Blue */
    'Weights': '#BF5AF2', 'Strength': '#BF5AF2', 'Core': '#BF5AF2', /* Apple Purple */
    'Yoga': '#32D74B', 'Pilates': '#32D74B', 'HIIT': '#32D74B', 'Other': '#8e8e93' /* Apple Green / Gray */
};

document.getElementById('date').valueAsDate = new Date();

// --- EVENT LISTENERS ---
typeSelect.addEventListener('change', updateFields);
form.addEventListener('submit', addWorkout);
statsTypeSelect.addEventListener('change', updateDashboard);
distYearSelect.addEventListener('change', drawDistribution);
globalDuration.addEventListener('input', calcPace);
runDistInput.addEventListener('input', calcPace);
importFileInput.addEventListener('change', handleImportFile);


// --- INITIAL RENDER ---
updateFields();
renderHistory();
updateDashboard();
initDistribution();

// --- FUNCTIONS ---
function updateFields() {
    document.querySelectorAll('.field-group').forEach(g => g.classList.remove('active'));
    const group = document.getElementById('fields-' + typeSelect.value.toLowerCase());
    if (group) group.classList.add('active');
}

function addWorkout(e) {
    e.preventDefault();
    const dateInput = document.getElementById('date');
    const durationInput = document.getElementById('duration');
    const notesInput = document.getElementById('notes');

    let details = [];
    const activeGroup = document.querySelector('.field-group.active');
    if (activeGroup) {
        const inputs = activeGroup.querySelectorAll('input, select');
        inputs.forEach(input => {
            if (input.value && input.value.trim() !== "") {
                let label = input.getAttribute('data-label') || input.placeholder || "Detail";
                label = label.replace(/\s*\(.*?\)\s*/g, ''); 
                let value = input.value;
                if(input.placeholder && input.placeholder.includes('km')) value += " km";
                if(input.placeholder && input.placeholder.includes('kg')) value += " kg";
                if(input.placeholder && input.placeholder.includes('m)')) value += " m";
                details.push({ label: label, value: value });
            }
        });
    }

    workouts.unshift({
        id: Date.now(),
        date: dateInput.value,
        type: typeSelect.value,
        duration: Number(durationInput.value),
        notes: notesInput.value,
        details: details
    });

    workouts.sort((a, b) => new Date(b.date) - new Date(a.date));
    localStorage.setItem('smartWorkouts', JSON.stringify(workouts));
    
    form.reset();
    dateInput.valueAsDate = new Date();
    updateFields();
    renderHistory();
    updateDashboard();
    initDistribution();
}

function remove(id) {
    if(!confirm("Delete this workout?")) return;
    const i = workouts.findIndex(w => w.id === id);
    if (i > -1) {
        workouts.splice(i, 1);
        localStorage.setItem('smartWorkouts', JSON.stringify(workouts));
        renderHistory();
        updateDashboard();
        initDistribution();
    }
}

// --- HISTORY RENDER ---
function renderHistory() {
    const list = document.getElementById('workoutList');
    const emptyState = document.getElementById('emptyState');
    list.innerHTML = '';
    
    const displayWorkouts = workouts.slice(0, 50); 
    emptyState.style.display = displayWorkouts.length ? 'none' : 'block';

    const groups = {};
    displayWorkouts.forEach(w => {
        if (!groups[w.date]) groups[w.date] = [];
        groups[w.date].push(w);
    });

    Object.keys(groups).forEach(dateKey => {
        const dayWorkouts = groups[dateKey];
        const dateObj = new Date(dateKey + 'T00:00:00'); // Add time to avoid timezone issues
        const dateStr = dateObj.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
        const dayDuration = dayWorkouts.reduce((sum, w) => sum + w.duration, 0);

        const dateRow = document.createElement('tr');
        dateRow.className = 'date-row';
        dateRow.innerHTML = `
            <td style="text-align:center;"><i class="fa-solid fa-chevron-right"></i></td>
            <td>
                ${dateStr} 
                <span style="font-weight:400; color:var(--text-secondary); font-size:12px;">
                   • ${dayWorkouts.length} Workout${dayWorkouts.length>1?'s':''}
                </span>
            </td>
            <td><strong>${dayDuration} min</strong></td>
            <td></td>
        `;
        
        dateRow.onclick = function() {
            this.classList.toggle('expanded');
            document.querySelectorAll(`.group-${dateKey}`).forEach(row => row.classList.toggle('visible'));
            const icon = this.querySelector('i');
            icon.style.transform = icon.style.transform === 'rotate(90deg)' ? 'rotate(0deg)' : 'rotate(90deg)';
        };
        list.appendChild(dateRow);

        dayWorkouts.forEach(w => {
            const tr = document.createElement('tr');
            tr.className = `workout-row group-${dateKey}`;
            
            tr.innerHTML = `
                <td></td>
                <td style="padding-left:12px;">
                    <span class="tag type-${w.type.toLowerCase().replace(/\s/g, '-') /* handles 'HIIT' -> 'hiit' */ }">${w.type}</span>
                    ${w.notes ? '<i class="fa-regular fa-angles-right" style="color:var(--primary);margin-left:8px;font-size:12px;"></i>' : ''} 
                </td>
                <td>${w.duration} min</td>
                <td>
                    <button class="bin" onclick="remove(${w.id}); event.stopPropagation();">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
            `;
            
            tr.onclick = function() {
                const det = document.getElementById(`details-${w.id}`);
                if(det) det.classList.toggle('visible');
            };
            list.appendChild(tr);

            if ((w.details && w.details.length) || w.notes) {
                const dTr = document.createElement('tr');
                dTr.id = `details-${w.id}`;
                dTr.className = 'details-row';
                let html = '<div class="details-content">';
                if(w.details) w.details.forEach(d => html += `<div><b>${d.label}:</b> ${d.value}</div>`);
                if(w.notes) html += `<div style="grid-column:1/-1; font-style:italic;">"${w.notes}"</div>`;
                html += '</div>';
                dTr.innerHTML = `<td colspan="4" style="padding:0">${html}</td>`;
                list.appendChild(dTr);
            }
        });
    });
}

// --- DISTRIBUTION CHART ---
function initDistribution() {
    const years = [...new Set(workouts.map(w => new Date(w.date).getFullYear()))];
    const currentYear = new Date().getFullYear();
    // Ensure current year is always an option if there's no data for it yet
    if(!years.includes(currentYear)) years.push(currentYear); 
    years.sort((a,b) => b - a);

    const oldVal = distYearSelect.value;
    distYearSelect.innerHTML = '';
    years.forEach(y => {
        const opt = document.createElement('option');
        opt.value = y;
        opt.text = y;
        distYearSelect.appendChild(opt);
    });

    if(years.includes(Number(oldVal))) distYearSelect.value = oldVal;
    else if (years.length > 0) distYearSelect.value = years[0]; // Select the latest year if old value is not found
    drawDistribution();
}

function drawDistribution() {
    const year = Number(distYearSelect.value);
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    
    const yearWorkouts = workouts.filter(w => new Date(w.date).getFullYear() === year);
    
    const monthData = Array(12).fill(null).map(() => ({ total: 0, types: {} }));
    const yearTotals = {}; 

    yearWorkouts.forEach(w => {
        const d = new Date(w.date + 'T00:00:00'); // Add time to avoid timezone issues
        const mIndex = d.getMonth();
        const type = w.type;
        monthData[mIndex].total++;
        monthData[mIndex].types[type] = (monthData[mIndex].types[type] || 0) + 1;
        yearTotals[type] = (yearTotals[type] || 0) + 1;
    });

    const dpr = window.devicePixelRatio || 1;
    const rect = distCanvas.getBoundingClientRect();
    distCanvas.width = rect.width * dpr;
    distCanvas.height = 320 * dpr;
    distCtx.scale(dpr, dpr);
    distCtx.clearRect(0, 0, rect.width, 320);

    const pad = { left: 40, right: 20, top: 20, bottom: 20 };
    const chartW = rect.width - pad.left - pad.right;
    const chartH = 320 - pad.top - pad.bottom;
    const rowH = chartH / 12;
    
    const maxMonthly = Math.max(...monthData.map(m => m.total), 1);
    
    distCtx.beginPath();
    distCtx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--border-color'); // Use CSS variable
    distCtx.moveTo(pad.left, pad.top);
    distCtx.lineTo(pad.left, 320 - pad.bottom);
    distCtx.stroke();

    months.forEach((m, i) => {
        const y = pad.top + (i * rowH);
        const barY = y + (rowH * 0.2);
        const barH = rowH * 0.6;
        
        distCtx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary'); // Use CSS variable
        distCtx.font = '11px -apple-system';
        distCtx.textAlign = 'right';
        distCtx.textBaseline = 'middle';
        distCtx.fillText(m, pad.left - 8, y + (rowH/2));

        let currentX = pad.left;
        const types = Object.keys(monthData[i].types).sort();
        
        types.forEach(type => {
            const count = monthData[i].types[type];
            const width = (count / maxMonthly) * chartW;
            const color = workoutColors[type] || '#8e8e93';

            distCtx.fillStyle = color;
            distCtx.fillRect(currentX, barY, width, barH);
            
            // Add a subtle separator between stacked bars
            // distCtx.fillStyle = 'rgba(0,0,0,0.1)'; 
            // distCtx.fillRect(currentX + width - 1, barY, 1, barH);

            currentX += width;
        });

        if(monthData[i].total > 0) {
            distCtx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary'); // Use CSS variable
            distCtx.textAlign = 'left';
            distCtx.fillText(monthData[i].total, currentX + 5, barY + barH/2);
        }
    });

    const legendEl = document.getElementById('distLegend');
    legendEl.innerHTML = '';
    
    const sortedTypes = Object.keys(yearTotals).sort((a,b) => yearTotals[b] - yearTotals[a]);
    const totalYearCount = yearWorkouts.length;

    if (totalYearCount === 0) {
        legendEl.innerHTML = `<div style="color:var(--text-secondary); width:100%; text-align:center; padding: 20px 0;">No data for ${year}</div>`;
        return;
    }

    sortedTypes.forEach(type => {
        const count = yearTotals[type];
        const percent = Math.round((count / totalYearCount) * 100);
        const color = workoutColors[type] || '#8e8e93';
        
        legendEl.innerHTML += `
            <div class="legend-item">
                <div class="legend-dot" style="background-color:${color}"></div>
                <div class="legend-info">
                    <span class="legend-name">${type}</span>
                    <span class="legend-stats">${count} (${percent}%)</span>
                </div>
            </div>
        `;
    });
}

// --- ANALYTICS ENGINE ---
function parseVal(str) {
    if(!str) return 0;
    const match = String(str).match(/[\d\.]+/); // Ensure str is a string for .match
    return match ? parseFloat(match[0]) : 0;
}

function getDetail(w, labelPart) {
    if(!w.details) return 0;
    const found = w.details.find(d => d.label.toLowerCase().includes(labelPart.toLowerCase()));
    return found ? parseVal(found.value) : 0;
}

function updateDashboard() {
    const type = statsTypeSelect.value;
    const filtered = workouts.filter(w => w.type === type).reverse();
    
    const byMonth = {};
    let totalDist = 0;
    let totalDur = 0;
    let totalSets = 0;
    let weightSum = 0; 
    let weightCount = 0;
    let speedSum = 0;
    let speedCount = 0;

    filtered.forEach(w => {
        const d = new Date(w.date + 'T00:00:00'); // Add time to avoid timezone issues
        const monthKey = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        
        if(!byMonth[monthKey]) byMonth[monthKey] = { count:0, dur:0, dist:0, speedAcc:0, speedN:0, sets:0, weightAcc:0, weightN:0 };
        
        const dist = getDetail(w, 'Distance'); 
        const speed = getDetail(w, 'Avg Speed'); // Ensure correct label for speed
        const sets = getDetail(w, 'Sets');
        const weight = getDetail(w, 'Weight');
        
        byMonth[monthKey].count++;
        byMonth[monthKey].dur += w.duration;
        byMonth[monthKey].dist += dist;
        byMonth[monthKey].sets += sets;
        if(speed > 0) { byMonth[monthKey].speedAcc += speed; byMonth[monthKey].speedN++; }
        if(weight > 0) { byMonth[monthKey].weightAcc += weight; byMonth[monthKey].weightN++; }

        totalDur += w.duration;
        totalDist += dist;
        totalSets += sets;
        if(speed > 0) { speedSum += speed; speedCount++; }
        if(weight > 0) { weightSum += weight; weightCount++; }
    });

    const cardContainer = document.getElementById('statCards');
    cardContainer.innerHTML = '';
    
    function createCard(color, label, value, unit) {
        return `<div class="stat-card ${color}"><div class="stat-label">${label}</div><div><span class="stat-value">${value}</span> <span class="stat-unit">${unit}</span></div></div>`;
    }

    if(type === 'Running' || type === 'Cycling' || type === 'Rowing' || type === 'Swimming') {
        const unit = (type==='Swimming') ? 'laps' : 'km';
        const distVal = (type==='Swimming') ? totalDist : totalDist.toFixed(1);
        const avgSpeed = speedCount ? (speedSum/speedCount).toFixed(1) : '-';
        
        cardContainer.innerHTML += createCard('orange', 'Total Distance', distVal, unit);
        cardContainer.innerHTML += createCard('blue', 'Total Time', Math.round(totalDur/60), 'hours');
        if(type !== 'Swimming') cardContainer.innerHTML += createCard('green', 'Avg Speed', avgSpeed, 'km/h');
    } 
    else if (type === 'Weights' || type === 'Strength') {
        const avgWeight = weightCount ? (weightSum/weightCount).toFixed(1) : '-';
        cardContainer.innerHTML += createCard('purple', 'Total Sets', totalSets, 'sets');
        cardContainer.innerHTML += createCard('blue', 'Avg Weight', avgWeight, 'kg');
        cardContainer.innerHTML += createCard('gray', 'Workouts', filtered.length, 'sessions');
    } 
    else {
        cardContainer.innerHTML += createCard('green', 'Total Time', totalDur, 'min');
        cardContainer.innerHTML += createCard('gray', 'Workouts', filtered.length, 'count');
    }

    const tHead = document.getElementById('statsTableHead');
    const tBody = document.getElementById('statsTableBody');
    tBody.innerHTML = '';

    if(type === 'Running' || type === 'Cycling' || type === 'Rowing') {
        tHead.innerHTML = `<tr><th>Month</th><th>Distance</th><th>Avg Speed</th><th>Time</th></tr>`;
        Object.keys(byMonth).sort().reverse().forEach(k => {
            const m = byMonth[k];
            const avgSp = m.speedN ? (m.speedAcc/m.speedN).toFixed(1) : '-';
            tBody.innerHTML += `<tr><td>${k}</td><td>${m.dist.toFixed(1)} km</td><td>${avgSp} km/h</td><td>${m.dur} min</td></tr>`;
        });
    } else if (type === 'Weights' || type === 'Strength') {
        tHead.innerHTML = `<tr><th>Month</th><th>Total Sets</th><th>Avg Weight</th><th>Time</th></tr>`;
        Object.keys(byMonth).sort().reverse().forEach(k => {
            const m = byMonth[k];
            const avgW = m.weightN ? (m.weightAcc/m.weightN).toFixed(1) : '-';
            tBody.innerHTML += `<tr><td>${k}</td><td>${m.sets}</td><td>${avgW} kg</td><td>${m.dur} min</td></tr>`;
        });
    } else {
        tHead.innerHTML = `<tr><th>Month</th><th>Workouts</th><th>Total Time</th></tr>`;
        Object.keys(byMonth).sort().reverse().forEach(k => {
             const m = byMonth[k];
             tBody.innerHTML += `<tr><td>${k}</td><td>${m.count}</td><td>${m.dur} min</td></tr>`;
        });
    }

    drawSpecificChart(byMonth, type);
}

function drawSpecificChart(dataObj, type) {
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.scale(dpr, dpr);
    ctx.clearRect(0,0, rect.width, rect.height);

    const keys = Object.keys(dataObj).sort().slice(-6); 
    if(!keys.length) {
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary');
        ctx.font = '14px -apple-system';
        ctx.textAlign = 'center';
        ctx.fillText('No data for this activity type.', rect.width / 2, rect.height / 2);
        return;
    }

    const width = rect.width;
    const height = rect.height;
    const pad = {top:20, bottom:30, left:40, right:10};

    let getValue;
    let color;

    if(['Running','Cycling','Rowing'].includes(type)) {
        getValue = (k) => dataObj[k].dist;
        color = workoutColors['Running']; // Use defined color
    } else if (type === 'Weights' || type === 'Strength') {
        getValue = (k) => dataObj[k].sets;
        color = workoutColors['Weights']; // Use defined color
    } else {
        getValue = (k) => dataObj[k].dur;
        color = workoutColors['Yoga']; // Use defined color
    }

    const values = keys.map(k => getValue(k));
    const maxVal = Math.max(...values, 1) * 1.2;

    ctx.beginPath();
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--border-color'); // Use CSS variable
    ctx.moveTo(pad.left, pad.top);
    ctx.lineTo(pad.left, height-pad.bottom);
    ctx.lineTo(width, height-pad.bottom);
    ctx.stroke();

    const slotW = (width - pad.left - pad.right) / keys.length;
    const barW = slotW * 0.5;

    keys.forEach((k, i) => {
        const val = values[i];
        const barH = (val / maxVal) * (height - pad.top - pad.bottom);
        const x = pad.left + (i * slotW) + (slotW/2 - barW/2);
        const y = height - pad.bottom - barH;

        const grd = ctx.createLinearGradient(0, y, 0, height-pad.bottom);
        grd.addColorStop(0, color);
        grd.addColorStop(1, color + '44'); // Add transparency for the bottom part
        ctx.fillStyle = grd;
        ctx.fillRect(x, y, barW, barH);

        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-main'); // Use CSS variable for text
        ctx.font = 'bold 10px -apple-system';
        ctx.textAlign = 'center';
        if(val > 0) ctx.fillText(Math.round(val), x + barW/2, y - 5);

        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary'); // Use CSS variable for text
        ctx.font = '10px -apple-system';
        ctx.fillText(k.split('-')[1], x + barW/2, height - pad.bottom + 12);
    });
}


// --- New: Export/Import Functions ---

function exportToJson() {
    const dataStr = JSON.stringify(workouts, null, 2); // null, 2 for pretty printing
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'smart_workout_data.json';
    document.body.appendChild(a); // Append to body to make it clickable in all browsers
    a.click();
    document.body.removeChild(a); // Clean up
    URL.revokeObjectURL(url); // Release the URL object
}

function importFromJson() {
    importFileInput.click(); // Trigger click on the hidden file input
}

function handleImportFile(event) {
    const file = event.target.files[0];
    if (!file) {
        return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const importedData = JSON.parse(e.target.result);
            
            // Basic validation: Check if it's an array and contains objects that look like workouts
            if (Array.isArray(importedData) && importedData.every(item => 
                typeof item === 'object' && item !== null && 
                item.hasOwnProperty('id') && item.hasOwnProperty('date') && item.hasOwnProperty('type')
            )) {
                if (confirm("Importing new data will overwrite your current workout history. Are you sure?")) {
                    workouts = importedData;
                    // Sort the imported data by date (newest first) to maintain consistent display
                    workouts.sort((a, b) => new Date(b.date) - new Date(a.date));
                    localStorage.setItem('smartWorkouts', JSON.stringify(workouts));
                    
                    // Re-render all UI components with the new data
                    renderHistory();
                    updateDashboard();
                    initDistribution();
                    alert('Workout data imported successfully!');
                }
            } else {
                alert('Invalid JSON file format. Please ensure it\'s a valid workout data export (array of workout objects with id, date, and type).');
            }
        } catch (error) {
            alert('Error parsing JSON file: ' + error.message);
        }
        // Clear the file input value to allow importing the same file again if needed
        event.target.value = ''; 
    };
    reader.onerror = () => {
        alert('Error reading file.');
    };
    reader.readAsText(file);
}


// ======================= WORKOUT PREP LOGIC =======================
let prepSteps = [];
let prepIsPlaying = false;

function togglePrepPlay() {
    prepIsPlaying = !prepIsPlaying;

    const playBtn = document.getElementById('prepPlayBtn');
    const activeControls = document.getElementById('prepActiveControls');

    if (prepIsPlaying) {
        playBtn.innerHTML = `<i class="fa-solid fa-circle-pause"></i><span>Pause</span>`;
        activeControls.classList.add('active');
    } else {
        playBtn.innerHTML = `<i class="fa-solid fa-play"></i><span>Play</span>`;
        activeControls.classList.remove('active');
    }
}

function stopPrep() {
    prepIsPlaying = false;

    document.getElementById('prepPlayBtn').innerHTML =
        `<i class="fa-solid fa-play"></i><span>Play</span>`;

    document.getElementById('prepActiveControls').classList.remove('active');
}

function prepStep(direction) {
    if (!prepIsPlaying) return;
    if (!prepSteps.length) return;
    console.log('Step', direction);
}


function calcPace() {
    const d = parseFloat(runDistInput.value);
    const t = parseFloat(globalDuration.value);
    
    if(d > 0 && t > 0) {
        const pace = t / d;
        runPaceInput.value = pace.toFixed(2);
    } else {
        runPaceInput.value = ''; // Clear pace if inputs are invalid
    }
}


function togglePrepInputs() {
    const target = document.getElementById('step-target-type').value;
    const label = document.getElementById('step-val-label');
    const input = document.getElementById('step-val');
    
    if(target === 'time') {
        label.textContent = "Duration (min)";
        input.placeholder = "Minutes";
    } else {
        label.textContent = "Distance (km)";
        input.placeholder = "Kilometers";
    }
}

function addPrepStep() {
    const phase = document.getElementById('step-phase');
    const targetType = document.getElementById('step-target-type').value;
    const val = parseFloat(document.getElementById('step-val').value) || 0;
    const intensity = document.getElementById('step-intensity').value;

    const phaseLabels = { 'warmup': 'Warm Up', 'work': 'Active Interval / Run', 'rest': 'Recovery / Rest', 'cooldown': 'Cool Down' };
    
    prepSteps.push({
        phase: phase.value,
        title: phaseLabels[phase.value],
        targetType: targetType,
        value: val,
        intensity: intensity
    });

    renderPrepList();
}

function removePrepStep(index) {
    prepSteps.splice(index, 1);
    renderPrepList();
}

function resetPrep() {
    prepSteps = [];
    renderPrepList();
}

function renderPrepList() {
    const list = document.getElementById('prep-list');
    list.innerHTML = '';
    
    let totalTime = 0;
    let totalDist = 0;

    prepSteps.forEach((step, index) => {
        // Stats Calc
        if(step.targetType === 'time') {
            totalTime += step.value;
            // For estimation, assume a general pace if time is given
            const prepWorkoutType = document.getElementById('prep-type').value;
            if (prepWorkoutType === 'Running' && step.value > 0) {
                 // Example: Estimate 1km for every 5 minutes of running
                totalDist += step.value / 5; 
            } else if (prepWorkoutType === 'Cycling' && step.value > 0) {
                // Example: Estimate 5km for every 10 minutes of cycling
                totalDist += (step.value / 10) * 5; 
            } else if (prepWorkoutType === 'Rowing' && step.value > 0) {
                // Example: Estimate 1.5km for every 10 minutes of rowing
                totalDist += (step.value / 10) * 1.5;
            }
        } else if(step.targetType === 'dist') {
            totalDist += step.value;
            // For estimation, assume a general time if distance is given
            const prepWorkoutType = document.getElementById('prep-type').value;
            if (prepWorkoutType === 'Running' && step.value > 0) {
                 // Example: Assume 5 minutes per km for running
                totalTime += step.value * 5; 
            } else if (prepWorkoutType === 'Cycling' && step.value > 0) {
                // Example: Assume 2 minutes per km for cycling
                totalTime += step.value * 2; 
            } else if (prepWorkoutType === 'Rowing' && step.value > 0) {
                // Example: Assume 6 minutes per km for rowing
                totalTime += step.value * 6;
            }
        }


        const li = document.createElement('li');
        li.className = `step-item step-${step.phase}`;
        
        let detailText = "";
        if(step.targetType === 'time') detailText = `${step.value} minutes`;
        else detailText = `${step.value} km`;

        li.innerHTML = `
            <div class="step-info">
                <span class="step-tag">${step.phase.toUpperCase()}</span>
                <span class="step-title">${step.title}</span>
                <span class="step-detail">
                    ${detailText} ${step.intensity ? '• ' + step.intensity : ''}
                </span>
            </div>
            <button class="bin" onclick="removePrepStep(${index})"><i class="fa-solid fa-xmark"></i></button>
        `;
        list.appendChild(li);
    });

    if(prepSteps.length === 0) {
        list.innerHTML = `<div style="text-align:center; padding:30px; color:var(--text-secondary); border: 2px dashed var(--border-color); border-radius:var(--radius-md);">Start adding steps to build your workout</div>`;
    }

    document.getElementById('prep-total-duration').textContent = Math.round(totalTime);
    document.getElementById('prep-total-distance').textContent = `${totalDist.toFixed(1)} km est.`;
}
</script>

</body>
</html>
